<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Meteo archiv</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #111;
      color: #fff;
    }
    header {
      padding: 10px 20px;
      display: flex;
      align-items: center;
      background: #000;
    }
    header h1 {
      margin: 0;
      flex: 1;
      font-size: 1.5em;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 15px;
    }
    .stats {
      display: flex;
      justify-content: space-between;
      margin: 10px;
    }
    .stat-box {
      flex: 1;
      margin: 5px;
      padding: 10px;
      background: #222;
      border-radius: 10px;
      text-align: center;
    }
    canvas {
      margin: 20px;
      background: #fff;
      border-radius: 10px;
    }
    @media (max-width: 768px) {
      .stats {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>🌦 Meteo archiv</h1>
  </header>

  <div class="controls">
    <label><input type="checkbox" id="tempCheckbox" checked> Teplota (°C)</label>
    <label><input type="checkbox" id="humCheckbox" checked> Vlhkost (%)</label>

    <select id="rangeSelect">
      <option value="today">Dnes</option>
      <option value="week">Týden</option>
      <option value="month">Měsíc</option>
      <option value="all">Vše</option>
    </select>

    <select id="fileSelect"></select>
    <button onclick="resetZoom()">Reset</button>
    <button onclick="downloadCSV()">CSV</button>
    <button onclick="downloadPNG()">PNG</button>
  </div>

  <div id="sensorCheckboxes" class="controls"></div>

  <div class="stats">
    <div class="stat-box">
      <h3>Min. teplota</h3>
      <p id="minTemp">–</p>
    </div>
    <div class="stat-box">
      <h3>Max. teplota</h3>
      <p id="maxTemp">–</p>
    </div>
  </div>

  <canvas id="chart" height="120"></canvas>

  <script>
    let chart;
    let allData = [];
    let sensorMap = { "2764": "Venek", "4065": "UNI", "Venek": "Venek", "UNI": "UNI" };

    async function loadFileList() {
      const res = await fetch("data/index.json");
      const files = await res.json();
      const select = document.getElementById("fileSelect");
      select.innerHTML = "";
      files.forEach(f => {
        const opt = document.createElement("option");
        opt.value = f;
        opt.textContent = f;
        if (f === "history.csv") opt.selected = true;
        select.appendChild(opt);
      });
      loadCSV(select.value);
    }

    async function loadCSV(file) {
      try {
        const res = await fetch("data/" + file + "?t=" + Date.now());
        const text = await res.text();
        const rows = text.trim().split("\n").map(r => r.split(","));
        const header = rows.shift();
        const tsIdx = header.indexOf("timestamp");
        const srcIdx = header.indexOf("source");
        const tIdx = header.indexOf("temp_c");
        const hIdx = header.indexOf("humidity_pct");

        allData = rows.map(r => ({
          t: new Date(r[tsIdx]),
          s: sensorMap[r[srcIdx]] || r[srcIdx],
          temp: parseFloat(r[tIdx]),
          hum: parseFloat(r[hIdx])
        }));

        updateSensors();
        updateChart();
      } catch (e) {
        alert("Nepodařilo se načíst data (CSV).");
      }
    }

    function updateSensors() {
      const container = document.getElementById("sensorCheckboxes");
      container.innerHTML = "";
      const sensors = [...new Set(allData.map(d => d.s))];
      sensors.forEach(s => {
        const lbl = document.createElement("label");
        lbl.innerHTML = `<input type="checkbox" value="${s}" checked> ${s}`;
        container.appendChild(lbl);
      });
    }

    function updateChart() {
      const showTemp = document.getElementById("tempCheckbox").checked;
      const showHum = document.getElementById("humCheckbox").checked;
      const selectedFile = document.getElementById("fileSelect").value;
      const range = document.getElementById("rangeSelect").value;
      const sensors = [...document.querySelectorAll("#sensorCheckboxes input:checked")].map(i => i.value);

      let filtered = allData.filter(d => sensors.includes(d.s));

      const now = new Date();
      if (range === "today") {
        const start = new Date(); start.setHours(0,0,0,0);
        filtered = filtered.filter(d => d.t >= start);
      }

      const datasets = [];
      sensors.forEach(s => {
        if (showTemp) datasets.push({
          label: s + " (°C)",
          data: filtered.filter(d => d.s===s).map(d => ({x:d.t,y:d.temp})),
          borderColor: s==="Venek"?"red":"blue",
          backgroundColor:"transparent",
          yAxisID:"y",
          tension:0.2,
          pointRadius:0
        });
        if (showHum) datasets.push({
          label: s + " (%)",
          data: filtered.filter(d => d.s===s).map(d => ({x:d.t,y:d.hum})),
          borderColor: s==="Venek"?"orange":"cyan",
          backgroundColor:"transparent",
          yAxisID:"y1",
          tension:0.2,
          pointRadius:0
        });
      });

      if(chart) chart.destroy();
      const ctx=document.getElementById("chart").getContext("2d");
      chart=new Chart(ctx,{
        type:"line",
        data:{datasets},
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{legend:{labels:{color:"#fff"}},zoom:{
            zoom:{wheel:{enabled:true},pinch:{enabled:true},mode:"x"},
            pan:{enabled:true,mode:"x"}
          }},
          scales:{
            x:{type:"time",time:{unit:"hour"},ticks:{color:"#fff"}},
            y:{title:{display:true,text:"°C"},ticks:{color:"#fff"}},
            y1:{position:"right",title:{display:true,text:"%"},grid:{drawOnChartArea:false},ticks:{color:"#fff"}}
          }
        }
      });

      // min/max temp
      const temps = filtered.map(d=>d.temp);
      if (temps.length) {
        const min = Math.min(...temps), max=Math.max(...temps);
        const minRec = filtered.find(d=>d.temp===min);
        const maxRec = filtered.find(d=>d.temp===max);
        document.getElementById("minTemp").textContent=`${min} °C (${minRec.s}, ${minRec.t.toLocaleString()})`;
        document.getElementById("maxTemp").textContent=`${max} °C (${maxRec.s}, ${maxRec.t.toLocaleString()})`;
      } else {
        document.getElementById("minTemp").textContent="–";
        document.getElementById("maxTemp").textContent="–";
      }
    }

    function resetZoom(){chart.resetZoom();}
    function downloadCSV(){
      const file=document.getElementById("fileSelect").value;
      window.location="data/"+file;
    }
    function downloadPNG(){
      const a=document.createElement("a");
      a.href=chart.toBase64Image();
      a.download="chart.png";
      a.click();
    }

    document.getElementById("fileSelect").addEventListener("change",e=>loadCSV(e.target.value));
    document.getElementById("rangeSelect").addEventListener("change",updateChart);
    document.getElementById("tempCheckbox").addEventListener("change",updateChart);
    document.getElementById("humCheckbox").addEventListener("change",updateChart);
    document.getElementById("sensorCheckboxes").addEventListener("change",updateChart);

    loadFileList();
  </script>
</body>
</html>
