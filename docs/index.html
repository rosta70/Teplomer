<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Meteo archiv</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <style>
    body.dark {
      background-color: #121212;
      color: #e1e1e1;
    }
    .card {
      border-radius: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    #chartContainer {
      height: 60vh; /* pÅ™izpÅ¯sobÃ­ se mobilu */
    }
    #chart {
      width: 100% !important;
      height: 100% !important;
    }
    .stat-value {
      font-size: 1.4rem;
      font-weight: bold;
    }
    .stat-detail {
      font-size: 0.9rem;
      opacity: 0.8;
    }
  </style>
</head>
<body class="light">

<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold">ðŸŒ¦ Meteo archiv</h2>
    <button id="toggleMode" class="btn btn-outline-secondary">
      <i class="bi bi-moon"></i> PÅ™epnout reÅ¾im
    </button>
  </div>

  <p><strong>Zdroj:</strong> <em>brrr.cz</em> â€¢ CSV z GitHub Pages</p>

  <!-- OvlÃ¡dacÃ­ panel -->
  <div class="row g-2 mb-3">
    <div class="col-auto">
      <input type="checkbox" id="showTemp" checked class="form-check-input">
      <label for="showTemp" class="form-check-label">Teplota (Â°C)</label>
    </div>
    <div class="col-auto">
      <input type="checkbox" id="showHum" checked class="form-check-input">
      <label for="showHum" class="form-check-label">Vlhkost (%)</label>
    </div>
    <div class="col-auto">
      <select id="rangeSelect" class="form-select">
        <option value="all">VÅ¡e</option>
        <option value="today">Dnes</option>
        <option value="week">TÃ½den</option>
        <option value="month">MÄ›sÃ­c</option>
      </select>
    </div>
    <div class="col-auto">
      <select id="fileSelect" class="form-select"></select>
    </div>
    <div class="col-auto">
      <button id="downloadCSV" class="btn btn-primary"><i class="bi bi-download"></i> CSV</button>
    </div>
    <div class="col-auto">
      <button id="downloadPNG" class="btn btn-success"><i class="bi bi-image"></i> PNG</button>
    </div>
  </div>

  <!-- ÄŒidla -->
  <div id="sensorCheckboxes" class="mb-3"></div>

  <!-- Statistika -->
  <div class="row mb-3 g-3">
    <div class="col-md-6">
      <div class="card p-3 text-center">
        <strong>Min. teplota</strong>
        <div id="minTemp" class="stat-value">â€“</div>
        <div id="minDetail" class="stat-detail"></div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card p-3 text-center">
        <strong>Max. teplota</strong>
        <div id="maxTemp" class="stat-value">â€“</div>
        <div id="maxDetail" class="stat-detail"></div>
      </div>
    </div>
  </div>

  <!-- Graf -->
  <div id="chartContainer" class="card p-3">
    <canvas id="chart"></canvas>
  </div>
</div>

<script>
let chart;
let allData = [];
let sensors = {};

const SENSOR_NAMES = {
  "4065": "UNI",
  "2764": "Venek"
};

async function loadFileList() {
  try {
    const res = await fetch("data/index.json");
    const files = await res.json();
    const select = document.getElementById("fileSelect");
    select.innerHTML = "";
    files.forEach(file => {
      const opt = document.createElement("option");
      opt.value = file;
      opt.textContent = file;
      select.appendChild(opt);
    });
    select.value = "history.csv";
    await loadData(select.value);
  } catch (err) {
    alert("NepodaÅ™ilo se naÄÃ­st index.json");
    console.error(err);
  }
}

async function loadData(file) {
  try {
    const res = await fetch("data/" + file);
    const text = await res.text();
    const rows = text.trim().split("\n").slice(1);
    allData = rows.map(line => {
      const [timestamp, source, temp, hum] = line.split(",");
      return {
        time: new Date(timestamp),
        source,
        temp: parseFloat(temp),
        hum: parseFloat(hum)
      };
    });
    sensors = {};
    allData.forEach(r => { sensors[r.source] = true; });
    renderSensorCheckboxes();
    updateChart();
  } catch (err) {
    alert("NepodaÅ™ilo se naÄÃ­st data (CSV).");
    console.error(err);
  }
}

function renderSensorCheckboxes() {
  const div = document.getElementById("sensorCheckboxes");
  div.innerHTML = "";
  Object.keys(sensors).forEach(s => {
    const id = "sensor_" + s;
    const wrapper = document.createElement("div");
    wrapper.classList.add("form-check", "form-check-inline");

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.id = id;
    cb.checked = true;
    cb.classList.add("form-check-input");
    cb.onchange = updateChart;

    const lbl = document.createElement("label");
    lbl.htmlFor = id;
    lbl.textContent = SENSOR_NAMES[s] || s;
    lbl.classList.add("form-check-label");

    wrapper.appendChild(cb);
    wrapper.appendChild(lbl);
    div.appendChild(wrapper);
  });
}

function filterData() {
  const range = document.getElementById("rangeSelect").value;
  let fromDate;
  const now = new Date();
  if (range === "today") {
    fromDate = new Date(); fromDate.setHours(0,0,0,0);
  } else if (range === "week") {
    fromDate = new Date(); fromDate.setDate(now.getDate()-7);
  } else if (range === "month") {
    fromDate = new Date(); fromDate.setMonth(now.getMonth()-1);
  }
  return allData.filter(r => {
    if (fromDate) return r.time >= fromDate;
    return true;
  });
}

function updateChart() {
  const data = filterData();
  const showTemp = document.getElementById("showTemp").checked;
  const showHum = document.getElementById("showHum").checked;
  const datasets = [];
  const selectedSensors = Object.keys(sensors).filter(s => document.getElementById("sensor_"+s).checked);

  selectedSensors.forEach(s => {
    const name = SENSOR_NAMES[s] || s;
    if (showTemp) {
      datasets.push({
        label: name + " (Â°C)",
        data: data.filter(r => r.source===s).map(r => ({x:r.time,y:r.temp})),
        borderColor: "red",
        backgroundColor: "rgba(255,0,0,0.2)",
        yAxisID: "y"
      });
    }
    if (showHum) {
      datasets.push({
        label: name + " (%)",
        data: data.filter(r => r.source===s).map(r => ({x:r.time,y:r.hum})),
        borderColor: "blue",
        backgroundColor: "rgba(0,0,255,0.2)",
        yAxisID: "y1"
      });
    }
  });

  if (chart) chart.destroy();
  chart = new Chart(document.getElementById("chart"), {
    type: "line",
    data: { datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "nearest", axis: "x", intersect: false },
      stacked: false,
      scales: {
        x: { type: "time", time: { unit: "hour" } },
        y: { type: "linear", position: "left", title:{display:true,text:"Â°C"} },
        y1: { type: "linear", position: "right", title:{display:true,text:"%"}, grid:{drawOnChartArea:false} }
      }
    }
  });

  // statistika
  const temps = data.map(r=>({val:r.temp,src:r.source,time:r.time})).filter(r=>!isNaN(r.val));
  if (temps.length) {
    const min = temps.reduce((a,b)=>a.val<b.val?a:b);
    const max = temps.reduce((a,b)=>a.val>b.val?a:b);
    document.getElementById("minTemp").textContent = min.val.toFixed(1)+" Â°C";
    document.getElementById("maxTemp").textContent = max.val.toFixed(1)+" Â°C";
    document.getElementById("minDetail").textContent = `${SENSOR_NAMES[min.src]||min.src}, ${min.time.toLocaleString()}`;
    document.getElementById("maxDetail").textContent = `${SENSOR_NAMES[max.src]||max.src}, ${max.time.toLocaleString()}`;
  } else {
    document.getElementById("minTemp").textContent = "â€“";
    document.getElementById("maxTemp").textContent = "â€“";
    document.getElementById("minDetail").textContent = "";
    document.getElementById("maxDetail").textContent = "";
  }
}

document.getElementById("rangeSelect").onchange = updateChart;
document.getElementById("fileSelect").onchange = e => loadData(e.target.value);
document.getElementById("toggleMode").onclick = () => {
  document.body.classList.toggle("dark");
};
document.getElementById("downloadCSV").onclick = () => {
  const csv = "timestamp,source,temp_c,humidity_pct\n" + allData.map(r =>
    `${r.time.toISOString()},${r.source},${r.temp},${r.hum}`).join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "data.csv";
  a.click();
};
document.getElementById("downloadPNG").onclick = () => {
  const a = document.createElement("a");
  a.href = chart.toBase64Image();
  a.download = "chart.png";
  a.click();
};

loadFileList();
</script>
</body>
</html>
