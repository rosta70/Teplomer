<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Meteo archiv</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js"></script>
  <style>
    /* Původní Téma: Oceanic Dark (Výchozí) */
    :root, .theme-dark {
      --bg: #0f1115;
      --card: #171a21;
      --muted: #9aa4b2;
      --text: #e7edf4;
      --accent: #2dd4bf;
      --danger: #f43f5e;
      --info: #60a5fa;
      --chart-bg: #fff; /* Barva pozadí grafu */
      --chart-legend-text: #111; /* Barva textu legendy */
    }

    /* Téma 2: Křišťálově bílé (Crystal Light) */
    .theme-light {
      --bg: #f8f8f8;
      --card: #ffffff;
      --muted: #6b7280;
      --text: #1f2937;
      --accent: #10b981;
      --danger: #dc2626;
      --info: #3b82f6;
      --chart-bg: #f5f5f5;
      --chart-legend-text: #111;
    }

    /* Téma 3: Černá a Bílá (Monochrome) */
    .theme-mono {
      --bg: #000000;
      --card: #111111;
      --muted: #aaaaaa;
      --text: #ffffff;
      --accent: #22c55e;
      --danger: #ef4444;
      --info: #3b82f6;
      --chart-bg: #fff;
      --chart-legend-text: #111;
    }


    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;}
    header{display:flex;align-items:center;gap:.6rem;padding:14px 18px;border-bottom:1px solid #222;}
    header .logo{width:22px;height:22px;background:radial-gradient(circle at 30% 30%,#ffd166 0,#2dd4bf 20%,#171a21 60%);border-radius:6px;box-shadow:0 0 0 2px var(--card);}
    h1{margin:0;font-size:1.4rem;font-weight:600;}
    main{max-width:1200px;margin:1rem auto;padding:0 18px;}
    .controls{display:flex;flex-wrap:wrap;gap:12px;padding:14px 0;border-bottom:1px solid var(--card);}
    .controls-group{display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
    .controls label{display:flex;gap:6px;align-items:center;}
    select, input[type=date]{background:var(--card);color:var(--text);border:1px solid #333;padding:6px 10px;border-radius:6px;}
    button{background:var(--card);color:var(--text);border:1px solid #333;padding:6px 10px;border-radius:6px;cursor:pointer;transition:background .1s;}
    button:hover{background:#333;}
    /* UPRAVENO: Grid pro statistiky a jejich karty */
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;padding:14px 0;}
    .stat-card{background:var(--card);padding:14px;border-radius:8px;box-shadow:0 4px 6px -1px rgba(0,0,0,.1); transition: box-shadow 0.3s;}
    .stat-card:hover{box-shadow:0 0 10px rgba(45, 212, 191, 0.4);}
    .stat-title{color:var(--muted);font-size:.8rem;font-weight:500;margin-bottom:4px;}
    .stat-value{font-size:1.5rem;font-weight:700;}
    .stat-group{display:flex;justify-content:space-between;align-items:baseline;margin-top:6px; flex-wrap: wrap;}
    .stat-detail{color:var(--muted); font-size: .85rem;}
    .stat-temp{color:var(--danger);}
    .stat-hum{color:var(--info);}
    .toggles{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0;}
    .toggle{padding:4px 10px;border-radius:20px;font-size:.9rem;cursor:pointer;background:var(--card);border:1px solid #333;transition:background .1s;}
    .toggle.active{background:var(--accent);border-color:var(--accent);color:var(--bg);font-weight:600;}
    .chart-container{padding:14px 0;}
    .custom-range-inputs{display:none;gap:12px;margin-top:12px;}
    .error-message{color:var(--danger);padding:10px;background:rgba(244,63,94,.1);border-radius:6px;border:1px solid var(--danger);margin-top:1rem;display:none;}
  </style>
</head>
<body class="theme-dark">
  <header>
    <div class="logo"></div>
    <h1>Meteo Archiv</h1>
  </header>
  <main>
    <div class="controls">
      <div class="controls-group">
        <label for="selFile">Archiv:</label>
        <select id="selFile"></select>
      </div>
      <div class="controls-group">
        <label for="selRange">Zobrazit:</label>
        <select id="selRange">
          <option value="today">Dnes</option>
          <option value="yesterday">Včera</option>
          <option value="last7">Posledních 7 dní</option>
          <option value="last30">Posledních 30 dní</option>
          <option value="all">Celý soubor</option>
          <option value="custom">Vlastní rozsah</option>
        </select>
        <div id="customRangeInputs" class="custom-range-inputs">
          <input type="date" id="dateFrom" title="Datum od" />
          <input type="date" id="dateTo" title="Datum do" />
        </div>
      </div>
      <div class="controls-group">
        <label for="chkTemp"><input type="checkbox" id="chkTemp" checked />Teplota</label>
        <label for="chkHum"><input type="checkbox" id="chkHum" />Vlhkost</label>
      </div>
      <div class="controls-group">
        <button id="btnReset" title="Resetovat zoom">Reset Zoom</button>
        <button id="btnCsv" title="Stáhnout data ve formátu CSV">CSV</button>
        <button id="btnPng" title="Uložit graf jako PNG obrázek">PNG</button>
      </div>
      <div class="controls-group">
        <label for="selTheme">Téma:</label>
        <select id="selTheme">
          <option value="theme-dark">Oceanic Dark</option>
          <option value="theme-light">Crystal Light</option>
          <option value="theme-mono">Monochrome</option>
        </select>
      </div>
    </div>

    <div id="errorMessage" class="error-message"></div>

    <div class="toggles" id="sensorToggles">
      </div>

    <div class="chart-container">
      <canvas id="meteoChart"></canvas>
    </div>

    <div class="stats" id="statsContainer">
      </div>
  </main>

  <script>
    // Zjednodušená verze document.querySelector
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    const $selRange = $("#selRange");
    const $dateFrom = $("#dateFrom");
    const $dateTo = $("#dateTo");
    const $selTheme = $("#selTheme");

    // --- Pomocné ---
    // Mapování ID senzoru (ze sloupce 'source' v CSV) na popisek pro web
    const SENSOR_LABEL = { "UNI": "UNI", "Venek": "Venek", "Doma": "Doma" };

    // NOVÉ: Centrální definice barev pro každý senzor a typ dat
    const SENSOR_COLORS = {
        "UNI": {
            temp: "#f43f5e",   // Malinově červená (UNI Teplota)
            hum:  "#fda4af"    // Světle růžová (UNI Vlhkost)
        },
        "Venek": {
            temp: "#2563eb",   // Intenzivní modrá (Venek Teplota)
            hum:  "#93c5fd"    // Světle modrá (Venek Vlhkost)
        },
        "Doma": {
            temp: "#059669",   // Tmavě zelená (Doma Teplota)
            hum:  "#6ee7b7"    // Světle zelená (Doma Vlhkost)
        },
        "Terasa": { 
            temp: "#a855f7",   // Fialová (Terasa Teplota)
            hum:  "#d8b4fe"    // Světle fialová (Terasa Vlhkost)
        }
    };
    
    let data = [];
    let chart = null;

    function formatTime(t) {
      // Vrací čas a datum pro statistiky
      return t.toLocaleString("cs-CZ", { dateStyle: "short", timeStyle: "short" });
    }

    function formatDateForInput(d) {
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Načte seznam dostupných CSV souborů (OPRAVENO: Jednoduchá cesta)
    async function loadIndex() {
      const file = "index.json";
      try {
        // Používáme nejjednodušší relativní cestu, protože index.html je v docs/
        const r = await fetch(`data/${file}`); 
        if (!r.ok) {
          // Pokud selže jednoduchá cesta, zkusíme záložní cestu (pro repozitáře, kde je web spuštěn z kořene)
          const backupR = await fetch(`docs/data/${file}`);
          if (backupR.ok) {
              return loadIndexFromResponse(backupR);
          }
          throw new Error(`Chyba při načítání ${file} (Status ${r.status})`);
        }
        
        return loadIndexFromResponse(r);
        
      } catch (err) {
        $("#errorMessage").textContent = `Kritická chyba: Nepodařilo se načíst index.json. Zkontrolujte cestu a nasazení souboru.`;
        $("#errorMessage").style.display = "block";
      }
    }

    // Pomocná funkce pro zpracování odpovědi z index.json
    async function loadIndexFromResponse(response) {
        const index = await response.json();
        const selFile = $("#selFile");
        selFile.innerHTML = "";
        index.forEach(f => {
          const opt = document.createElement("option");
          opt.value = f;
          opt.textContent = f;
          selFile.appendChild(opt);
        });
        await loadCSV();
        $selRange.value = "last30";
        update();
    }


    // Načte vybraný CSV soubor (OPRAVENO: Jednoduchá cesta)
    async function loadCSV() {
      const f = $("#selFile").value;
      const fileUrl = `data/${f}`; // Nejjednodušší relativní cesta pro CSV
      $("#errorMessage").style.display = "none";
      
      try {
        const r = await fetch(fileUrl);
        if (!r.ok) {
          throw new Error(`Soubor ${fileUrl} nenalezen (Status: ${r.status}).`);
        }
        const csvText = await r.text();
        data = parseCSV(csvText);
        
        renderSensorToggles(data);
        update(); 

      } catch (err) {
        $("#errorMessage").textContent = `Chyba při načítání dat: ${err.message}`;
        $("#errorMessage").style.display = "block";
        data = []; // Vyčistit data při chybě
        update();
      }
    }
    
    // Zpracování CSV dat
    function parseCSV(csv) {
      const lines = csv.trim().split('\n').filter(line => line.trim() !== '');
      if (lines.length === 0) return [];
      
      const header = lines[0].split(',').map(h => h.trim());
      const records = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',');
        if (values.length !== header.length) continue;

        const record = {
          time: new Date(values[0].trim()),
          id: values[1].trim(), // Toto nyní obsahuje textové ID ("UNI", "Venek", "Doma")
          temp: parseFloat(values[2].trim()) || null,
          hum: parseFloat(values[3].trim()) || null,
        };
        records.push(record);
      }
      return records.sort((a, b) => a.time - b.time); // Seřazení pro Chart.js
    }
    
    // Přepínání zobrazení Vlastního rozsahu
    function toggleCustomRangeInputs() {
        const isCustom = $selRange.value === 'custom';
        $("#customRangeInputs").style.display = isCustom ? 'flex' : 'none';
        
        // Nastavení výchozích hodnot, pokud je "Custom" vybráno poprvé
        if (isCustom && !$dateFrom.value && data.length > 0) {
            const firstDate = data[0].time;
            const lastDate = data[data.length - 1].time;
            
            $dateFrom.value = formatDateForInput(firstDate);
            $dateTo.value = formatDateForInput(lastDate);
        }
    }


    // Filtrování dat na základě rozsahu
    function filterData(data) {
      if (data.length === 0) return [];
      
      let startDate, endDate;
      const now = new Date();
      const range = $selRange.value;

      // Nastavení data podle předvolby
      switch (range) {
        case 'today':
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          endDate = now;
          break;
        case 'yesterday':
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
          endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()); // Do začátku dneška
          break;
        case 'last7':
          startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
          endDate = now;
          break;
        case 'last30':
          startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
          endDate = now;
          break;
        case 'custom':
          if ($dateFrom.value) startDate = new Date($dateFrom.value);
          if ($dateTo.value) endDate = new Date($dateTo.value);
          
          if (!startDate || !endDate || startDate.getTime() >= endDate.getTime()) {
            // Při chybě rozsahu se vrátí "Celý soubor"
            return data;
          }
          // Posun koncového data na konec dne
          endDate.setHours(23, 59, 59, 999); 
          break;
        case 'all':
        default:
          return data; // Celý soubor
      }

      // Filtrování a zohlednění časové zóny
      return data.filter(r => r.time >= startDate && r.time <= endDate);
    }

    // Statistické výpočty
    function calculateStats(rows) {
      const sensorIds = [...new Set(rows.map(r => r.id))];
      const stats = {};

      sensorIds.forEach(id => {
        const srows = rows.filter(r => r.id === id);
        if (srows.length === 0) return;

        const temps = srows.filter(r => r.temp !== null);
        const hums = srows.filter(r => r.hum !== null);
        
        // --- VÝPOČET TEPLOTY ---
        const minT = temps.length ? temps.reduce((a, b) => b.temp < a.temp ? b : a) : null;
        const maxT = temps.length ? temps.reduce((a, b) => b.temp > a.temp ? b : a) : null;
        const sumT = temps.reduce((acc, r) => acc + r.temp, 0);
        const avgT = temps.length ? (sumT / temps.length) : null;
        
        // --- VÝPOČET VLHKOSTI ---
        const minH = hums.length ? hums.reduce((a, b) => b.hum < a.hum ? b : a) : null;
        const maxH = hums.length ? hums.reduce((a, b) => b.hum > a.hum ? b : a) : null;
        const sumH = hums.reduce((acc, r) => acc + r.hum, 0);
        const avgH = hums.length ? (sumH / hums.length) : null;

        // Poslední záznam
        const lastRecord = srows[srows.length - 1];

        stats[id] = {
          name: SENSOR_LABEL[id] ?? id,
          // Teplota
          minTemp: minT, maxTemp: maxT, avgTemp: avgT,
          // Vlhkost
          minHum: minH, maxHum: maxH, avgHum: avgH,
          // Aktuální
          lastTemp: lastRecord.temp, lastHum: lastRecord.hum,
          lastTime: formatTime(lastRecord.time)
        };
      });
      return stats;
    }

    // Renderování statistik do karet
    function renderStats(rows) {
      const stats = calculateStats(rows);
      const container = $("#statsContainer");
      container.innerHTML = "";
      
      const showTemp = $("#chkTemp").checked;
      const showHum = $("#chkHum").checked;

      for (const id in stats) {
        const s = stats[id];
        const card = document.createElement("div");
        card.classList.add("stat-card");
        
        // ÚVOD: Jméno senzoru a čas posledního záznamu
        let content = `<div class="stat-title">${s.name} (Aktuální: ${s.lastTime})</div><hr style="border-color:var(--muted);margin:10px 0;opacity:0.2"/>`;

        // --- Zobrazení Teploty ---
        if (showTemp && s.maxTemp) {
            content += `
                <div class="stat-title">TEPLOTA</div>
                <div class="stat-value stat-temp">${s.lastTemp?.toFixed(2) ?? '—'} °C</div>
                <div class="stat-group">
                    <div class="stat-detail stat-temp">Min: ${s.minTemp.temp.toFixed(2)} °C <span style="font-size: 0.75rem">(${formatTime(s.minTemp.time)})</span></div>
                    <div class="stat-detail stat-temp">Max: ${s.maxTemp.temp.toFixed(2)} °C <span style="font-size: 0.75rem">(${formatTime(s.maxTemp.time)})</span></div>
                </div>
                <div class="stat-title" style="margin-top: 5px;">Průměr: ${s.avgTemp.toFixed(2)} °C</div>
            `;
        }

        // --- Zobrazení Vlhkosti ---
        if (showHum && s.maxHum) {
             content += `<hr style="border-color:var(--muted);margin:10px 0;opacity:0.2"/>`;
             content += `
                <div class="stat-title">VLHKOST</div>
                <div class="stat-value stat-hum">${s.lastHum?.toFixed(2) ?? '—'} %</div>
                <div class="stat-group">
                    <div class="stat-detail stat-hum">Min: ${s.minHum.hum.toFixed(2)} % <span style="font-size: 0.75rem">(${formatTime(s.minHum.time)})</span></div>
                    <div class="stat-detail stat-hum">Max: ${s.maxHum.hum.toFixed(2)} % <span style="font-size: 0.75rem">(${formatTime(s.maxHum.time)})</span></div>
                </div>
                <div class="stat-title" style="margin-top: 5px;">Průměr: ${s.avgHum.toFixed(2)} %</div>
            `;
        }
        
        card.innerHTML = content;
        container.appendChild(card);
      }
    }

    // Generování přepínačů senzorů
    function renderSensorToggles(data) {
      const allIds = [...new Set(data.map(r => r.id))];
      const container = $("#sensorToggles");
      container.innerHTML = "";

      allIds.forEach(id => {
        const toggle = document.createElement("div");
        toggle.classList.add("toggle");
        toggle.textContent = SENSOR_LABEL[id] ?? id;
        toggle.dataset.sensorId = id;
        
        // Na začátku jsou všechny aktivní, pokud nemáme uložený stav
        if (localStorage.getItem(`sensor-${id}`) !== 'false') {
             toggle.classList.add("active");
        }
        
        // Akce pro přepínání
        toggle.addEventListener("click", () => {
          toggle.classList.toggle("active");
          const isActive = toggle.classList.contains("active");
          localStorage.setItem(`sensor-${id}`, isActive);
          update(); // Aktualizace grafu po přepnutí
        });
        container.appendChild(toggle);
      });
    }

    // Filtrování dat podle přepínačů senzorů
    function filterBySensor(rows) {
      const activeSensors = [];
      $$(".toggle.active").forEach(t => {
        activeSensors.push(t.dataset.sensorId);
      });

      // Pokud není aktivní žádný senzor, zobrazíme všechny, aby se graf nezhroutil
      if (activeSensors.length === 0) return rows; 

      return rows.filter(r => activeSensors.includes(r.id));
    }


    function drawChart(datasets) {
      const isDarkMode = document.body.classList.contains("theme-dark");
      const chartTextColor = isDarkMode ? 'var(--text)' : 'var(--chart-legend-text)';
      const gridColor = isDarkMode ? '#222' : '#ddd';

      const config = {
        type: "line",
        data: { datasets: datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          color: chartTextColor,
          scales: {
            x: { type: "time", time: { unit: "hour" }, ticks: { color: chartTextColor }, grid: { color: gridColor } },
            yT: { position: "left", title:{display:true,text:"°C"}, ticks: { color: chartTextColor }, grid: { color: gridColor } },
            yH: { position: "right", title:{display:true,text:"%"}, ticks: { color: chartTextColor }, grid: { drawOnChartArea: false, color: gridColor }, suggestedMin: 0, suggestedMax: 100 }
          },
          plugins: {
            legend: { labels: { color: chartTextColor, font:{weight:"600"} } },
            zoom: {
              zoom: { wheel:{enabled:true}, pinch:{enabled:true}, mode:"x" },
              pan:  { enabled:true, mode:"x" }
            }
          }
        }
      };

      if (chart) {
        chart.data.datasets = datasets;
        chart.options.scales.x.ticks.color = chartTextColor;
        chart.options.scales.yT.ticks.color = chartTextColor;
        chart.options.scales.yH.ticks.color = chartTextColor;
        chart.options.plugins.legend.labels.color = chartTextColor;
        chart.update();
      } else {
        chart = new Chart($("#meteoChart"), config);
      }
    }


    function update() {
      // 1. Vyfiltrovat podle časového rozsahu (celý soubor, dnes, včera, custom...)
      let rows = filterData(data);
      // 2. Vyfiltrovat podle přepínačů senzorů
      rows = filterBySensor(rows); 
      
      const showTemp = $("#chkTemp").checked;
      const showHum = $("#chkHum").checked;

      // --- Graf: Sestavení Datasets ---
      const datasets = [];
      // Zjistíme, jaké ID senzorů nám zbyly po filtrování
      const ids = [...new Set(rows.map(r => r.id))];

      
      ids.forEach(id => {
        const srows = rows.filter(r => r.id === id);
        
        // Získáme barvy pro daný ID senzoru z nové mapy, pokud existují, jinak default šedá
        const colors = SENSOR_COLORS[id] || { temp: "#cccccc", hum: "#eeeeee" };

        if (showTemp) {
          datasets.push({
            label: `${SENSOR_LABEL[id] ?? id} (°C)`,
            data: srows.map(r => ({ x: r.time, y: r.temp })),
            borderColor: colors.temp, // Používá unikátní barvu pro teplotu
            backgroundColor: "transparent",
            yAxisID: "yT",
            tension: .2,
            pointRadius: 0,
            borderWidth: 2,
            borderDash: [] // Plná čára pro teplotu
          });
        }
        if (showHum) {
          datasets.push({
            label: `${SENSOR_LABEL[id] ?? id} (%)`,
            data: srows.map(r => ({ x: r.time, y: r.hum })),
            borderColor: colors.hum, // Používá unikátní světlejší barvu pro vlhkost
            backgroundColor: "transparent",
            yAxisID: "yH",
            tension: .2,
            pointRadius: 0,
            borderWidth: 2,
            borderDash: [6, 4] // Přerušovaná čára pro vlhkost
          });
        }
      });

      drawChart(datasets);
      renderStats(rows);
    }

    // --- Akce (UPRAVENO pro vlastní rozsah) ---
    function toggleCustomRangeInputs() {
        const isCustom = $selRange.value === 'custom';
        $("#customRangeInputs").style.display = isCustom ? 'flex' : 'none';
        
        if (isCustom && !$dateFrom.value && data.length > 0) {
            const lastDate = new Date();
            const firstDate = new Date(lastDate.getTime() - 30 * 24 * 60 * 60 * 1000); // 30 dní zpět
            
            $dateFrom.value = formatDateForInput(firstDate);
            $dateTo.value = formatDateForInput(lastDate);
        }
    }

    // Obnovení uloženého tématu
    const savedTheme = localStorage.getItem('selectedTheme') || 'theme-dark';
    document.body.className = ''; 
    document.body.classList.add(savedTheme);
    $selTheme.value = savedTheme;

    $("#selFile").addEventListener("change", loadCSV);
    
    // Sloučíme akce pro selRange
    $selRange.addEventListener("change", () => {
        toggleCustomRangeInputs(); // Přepne zobrazení polí
        update(); // Aktualizuje graf
    });

    // Akce pro přepínání témat
    $selTheme.addEventListener("change", (e) => {
      // 1. Odeber všechny existující třídy témat
      document.body.className = ''; 
      // 2. Přidej novou třídu na <body>
      document.body.classList.add(e.target.value);
      // 3. Ulož výběr (pro zapamatování)
      localStorage.setItem('selectedTheme', e.target.value); 
      // 4. Překresli graf, aby se zohlednily barvy legendy/osy
      update(); 
    });

    $("#chkTemp").addEventListener("change", update);
    $("#chkHum").addEventListener("change", update);

    // Posluchači pro pole vlastního rozsahu
    $dateFrom.addEventListener("change", update);
    $dateTo.addEventListener("change", update);

    $("#btnReset").addEventListener("click", ()=> chart && chart.resetZoom());
    $("#btnCsv").addEventListener("click", ()=> {
      const f = $("#selFile").value;
      // preferuj /data - když neexistuje, vezmi /docs/data
      fetch(`data/${f}`,{method:"HEAD"}).then(r=>{
        location.href = r.ok ? `data/${f}` : `docs/data/${f}`;
      }).catch(()=> location.href = `data/${f}`);
    });
    $("#btnPng").addEventListener("click", ()=> {
      const a = document.createElement("a");
      a.href = chart.toBase64Image(); a.download = "graf.png"; a.click();
    });

    // start
    loadIndex().catch(err=>{
      $("#errorMessage").textContent = `Kritická chyba: ${err.message}.`;
      $("#errorMessage").style.display = "block";
    });

  </script>
</body>
</html>
