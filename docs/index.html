<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meteo archiv â€“ jednoduchÃ½ graf</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.js"></script>

  <style>
    :root {
      --bg:#0b1220; --panel:#0e1626; --fg:#e7eef7; --muted:#a5b3c8;
      --chip:#0f1c36; --chip-b:#2f5fa8;
    }
    :root.light {
      --bg:#f6f8fb; --panel:#ffffff; --fg:#0b1220; --muted:#5c6b82;
      --chip:#eef2f9; --chip-b:#b9c7e6;
    }
    *{box-sizing:border-box}
    body{margin:24px;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--fg)}
    .wrap{max-width:1100px;margin:0 auto}
    h1{margin:0 0 8px}
    .sub{color:var(--muted);margin-bottom:16px}

    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .chip{background:var(--chip);border:1px solid var(--chip-b);border-radius:10px;padding:8px 10px}
    .srcs label{margin-right:10px}
    .chart{background:var(--panel);border:1px solid var(--chip-b);border-radius:14px;padding:12px}
    canvas{width:100%;height:420px !important}
    .muted{color:var(--muted)}
    button{cursor:pointer;border:1px solid var(--chip-b);background:var(--chip);color:var(--fg);border-radius:10px;padding:8px 10px}

    .stats {display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
    .stat  {background:var(--chip);border:1px solid var(--chip-b);border-radius:10px;padding:10px}
    .stat .label{font-size:.9rem;color:var(--muted);margin-bottom:4px}
    .stat .val{font-weight:600;line-height:1.35}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Meteo archiv</h1>
    <div class="sub">Zdroj: <code>brrr.cz</code> Â· CSV z GitHub Pages Â· levÃ¡ osa Â°C, pravÃ¡ osa %</div>

    <div class="controls">
      <label class="chip"><input type="checkbox" id="showTemp" checked> Teplota (Â°C)</label>
      <label class="chip"><input type="checkbox" id="showHum" checked> Vlhkost (%)</label>

      <div class="chip">
        Rozsah:
        <select id="range">
          <option value="all" selected>VÅ¡e</option>
          <option value="30d">PoslednÃ­ch 30 dnÃ­</option>
          <option value="7d">PoslednÃ­ch 7 dnÃ­</option>
          <option value="today">Dnes</option>
          <option value="custom">VlastnÃ­â€¦</option>
        </select>
      </div>

      <div class="chip" id="customRange" style="display:none">
        <label>Od: <input type="date" id="fromDate"></label>
        <label>Do: <input type="date" id="toDate"></label>
        <button id="applyRange" type="button">PouÅ¾Ã­t</button>
      </div>

      <div class="chip srcs" id="srcToggles"></div>

      <button id="theme">ðŸŒ“ ReÅ¾im</button>
      <a id="dlCsv" class="muted" href="#" download="history.csv">StÃ¡hnout CSV</a>
    </div>

    <div class="stats">
      <div class="stat">
        <div class="label">Min. teplota (vybranÃ½ rozsah)</div>
        <div class="val" id="tmin">â€“</div>
      </div>
      <div class="stat">
        <div class="label">Max. teplota (vybranÃ½ rozsah)</div>
        <div class="val" id="tmax">â€“</div>
      </div>
    </div>

    <div class="chart">
      <canvas id="chart"></canvas>
      <div id="nodata" class="muted" style="padding:10px;display:none">Å½Ã¡dnÃ¡ data pro zvolenÃ½ filtr.</div>
    </div>
  </div>

<script>
(() => {
  const repo = location.pathname.split('/').filter(Boolean)[0] || '';
  const CSV_URL = `/${repo ? repo + '/' : ''}docs/data/history.csv`;
  const csvLink = document.getElementById('dlCsv');

  async function loadCsv() {
    const r = await fetch(CSV_URL, {cache:'no-store'});
    if(r.ok){ csvLink.href=CSV_URL; return await r.text(); }
    throw new Error('CSV nenalezeno');
  }

  const fmt = (n,d=2)=> (n===null||n===undefined||Number.isNaN(n))?'â€“':Number(n).toFixed(d);
  const unique = arr => Array.from(new Set(arr));

  function parseCsv(text){
    const lines = text.replace(/\uFEFF/g,'').split(/\r?\n/).filter(l=>l.trim().length>0);
    const header = lines[0].split(',');
    const idxTs = header.indexOf('timestamp');
    const idxS  = header.indexOf('source');
    const idxT  = header.indexOf('temp_c');
    const idxH  = header.indexOf('humidity_pct');
    const rows  = lines.slice(1);

    const out=[];
    for(const l of rows){
      const p=l.split(',');
      if (p.length < 4) continue;
      const ts = new Date(p[idxTs]);
      if (Number.isNaN(ts.getTime())) continue;
      const src = (p[idxS]||'').trim();
      const temp = p[idxT]? Number(p[idxT]): null;
      const hum  = p[idxH]? Number(p[idxH]): null;
      out.push({ ts, src, temp, hum });
    }
    return out.sort((a,b)=>a.ts-b.ts);
  }

  function buildLabels(rows){
    return rows.map(r => r.ts.toLocaleString('cs-CZ',{hour12:false}));
  }

  function rangeFilter(rows, mode, fromDate, toDate){
    const now=new Date();
    let from=new Date(0), to=new Date(8640000000000000);
    if (mode==='today'){ const d0=new Date(now); d0.setHours(0,0,0,0); const d1=new Date(now); d1.setHours(23,59,59,999); from=d0; to=d1; }
    else if (mode==='7d')  from=new Date(now.getTime()-7*24*3600*1000);
    else if (mode==='30d') from=new Date(now.getTime()-30*24*3600*1000);
    else if (mode==='custom'){
      if (fromDate) from=new Date(fromDate+'T00:00:00');
      if (toDate)   to  =new Date(toDate  +'T23:59:59');
    }
    return rows.filter(r => r.ts>=from && r.ts<=to).sort((a,b)=>a.ts-b.ts);
  }

  function makeDatasets(labels, rows, enabledSources, showTemp, showHum){
    const datasets=[];
    for(const src of enabledSources){
      const arr = rows.filter(r=>r.src===src);
      if (showTemp){
        const mapT=new Map(arr.map(r=>[ r.ts.toLocaleString('cs-CZ',{hour12:false}), r.temp ]));
        const dataT = labels.map(L => mapT.has(L)? mapT.get(L): null);
        datasets.push({ label:`Teplota (Â°C) â€“ ${src}`, data:dataT, yAxisID:'yT', tension:0.25, spanGaps:true, pointRadius:0 });
      }
      if (showHum){
        const mapH=new Map(arr.map(r=>[ r.ts.toLocaleString('cs-CZ',{hour12:false}), r.hum ]));
        const dataH = labels.map(L => mapH.has(L)? mapH.get(L): null);
        datasets.push({ label:`Vlhkost (%) â€“ ${src}`, data:dataH, yAxisID:'yH', tension:0.25, spanGaps:true, pointRadius:0 });
      }
    }
    return datasets;
  }

  const showTempEl = document.getElementById('showTemp');
  const showHumEl  = document.getElementById('showHum');
  const rangeEl    = document.getElementById('range');
  const customWrap = document.getElementById('customRange');
  const fromEl     = document.getElementById('fromDate');
  const toEl       = document.getElementById('toDate');
  const applyBtn   = document.getElementById('applyRange');
  const togglesEl  = document.getElementById('srcToggles');
  const themeBtn   = document.getElementById('theme');
  const ctx        = document.getElementById('chart').getContext('2d');
  const noDataEl   = document.getElementById('nodata');
  const tminEl     = document.getElementById('tmin');
  const tmaxEl     = document.getElementById('tmax');

  if (localStorage.getItem('theme')==='light') document.documentElement.classList.add('light');
  themeBtn.addEventListener('click', () => {
    document.documentElement.classList.toggle('light');
    localStorage.setItem('theme', document.documentElement.classList.contains('light')?'light':'dark');
  });

  let chart, RAW=[], sources=[], enabledSrc={}, currentRange='all', currentFrom='', currentTo='';

  loadCsv()
    .then(text => {
      RAW = parseCsv(text);
      sources = unique(RAW.map(r=>r.src)).sort();
      togglesEl.innerHTML = '';
      sources.forEach(src => {
        enabledSrc[src]=true;
        const id='src_'+src.replace(/\W/g,'_');
        const lbl=document.createElement('label'); lbl.className='chip';
        lbl.innerHTML = `<input type="checkbox" id="${id}" data-src="${src}" checked> Stanice ${src}`;
        lbl.addEventListener('change', e => { enabledSrc[src] = e.target.checked; redraw(); });
        togglesEl.appendChild(lbl);
      });
      redraw();
    })
    .catch(err => { console.error(err); alert('NepodaÅ™ilo se naÄÃ­st data (CSV).'); });

  showTempEl.addEventListener('change', redraw);
  showHumEl .addEventListener('change', redraw);
  rangeEl   .addEventListener('change', () => {
    currentRange = rangeEl.value;
    customWrap.style.display = (currentRange === 'custom') ? 'inline-flex' : 'none';
    if (currentRange !== 'custom') { currentFrom=''; currentTo=''; fromEl.value=''; toEl.value=''; }
    redraw();
  });
  applyBtn  .addEventListener('click', () => {
    currentFrom = fromEl.value || '';
    currentTo   = toEl.value   || '';
    redraw();
  });

  function updateExtremes(rows){
    const tRows = rows.filter(r=>r.temp!==null && !Number.isNaN(r.temp));
    if (!tRows.length) { tminEl.textContent='â€“'; tmaxEl.textContent='â€“'; return; }
    const minR = tRows.reduce((m,r)=> r.temp < m.temp ? r : m, tRows[0]);
    const maxR = tRows.reduce((m,r)=> r.temp > m.temp ? r : m, tRows[0]);
    tminEl.textContent = `${minR.temp.toFixed(2)} Â°C â€” ${minR.ts.toLocaleString('cs-CZ',{hour12:false})} (stanice ${minR.src})`;
    tmaxEl.textContent = `${maxR.temp.toFixed(2)} Â°C â€” ${maxR.ts.toLocaleString('cs-CZ',{hour12:false})} (stanice ${maxR.src})`;
  }

  function redraw(){
    const enabled = sources.filter(s => enabledSrc[s]);
    const filtered = rangeFilter(RAW, currentRange, currentFrom, currentTo).filter(r => enabled.includes(r.src));
    const labels   = buildLabels(filtered);
    const datasets = makeDatasets(labels, filtered, enabled, showTempEl.checked, showHumEl.checked);

    updateExtremes(filtered);

    const hasData = datasets.some(ds => ds.data.some(v => v !== null));
    if (!labels.length || !hasData){
      if (chart){ chart.destroy(); chart=null; }
      noDataEl.style.display='block';
      return;
    } else {
      noDataEl.style.display='none';
    }

    const tVals = datasets.filter(d=>d.yAxisID==='yT').flatMap(d=>d.data).filter(v=>v!==null&&!Number.isNaN(v));
    const tMin  = tVals.length? Math.min(...tVals) : undefined;
    const tMax  = tVals.length? Math.max(...tVals) : undefined;
    const yTopt = (tMin!==undefined && tMax!==undefined) ? {
      suggestedMin: tMin - Math.abs(tMax - tMin)*0.1,
      suggestedMax: tMax + Math.abs(tMax - tMin)*0.1
    } : {};

    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type:'line',
      data:{ labels, datasets },
      options:{
        responsive:true, maintainAspectRatio:false, animation:false,
        interaction:{ mode:'index', intersect:false },
        scales:{
          x:{ ticks:{ autoSkip:true, maxRotation:45, minRotation:45, maxTicksLimit:6 } },
          yT:{ title:{display:true, text:'Â°C'}, grid:{drawBorder:false}, ...yTopt },
          yH:{ position:'right', title:{display:true, text:'%'}, grid:{drawOnChartArea:false}, suggestedMin:0, suggestedMax:100 }
        },
        plugins:{ legend:{ position:'top' } }
      }
    });
  }
})();
</script>
</body>
</html>
