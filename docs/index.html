<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Meteo archiv</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
    h1 { margin-bottom: 5px; }
    .controls { margin-bottom: 15px; }
    .controls label { margin-right: 10px; }
    canvas { max-width: 100%; height: 400px; }
  </style>
</head>
<body>
  <h1>Meteo archiv</h1>
  <p>Zdroj: <b>brrr.cz</b> • CSV z GitHub Pages • levá osa = teplota (°C), pravá osa = vlhkost (%)</p>

  <div class="controls">
    <label><input type="checkbox" id="showTemp" checked> Teplota (°C)</label>
    <label><input type="checkbox" id="showHumidity" checked> Vlhkost (%)</label>

    <label for="fileSelect">Soubor:</label>
    <select id="fileSelect"></select>
  </div>

  <div>
    <strong>Min. teplota:</strong> <span id="minTemp">-</span> °C,
    <strong>Max. teplota:</strong> <span id="maxTemp">-</span> °C
  </div>

  <canvas id="chart"></canvas>

  <script>
    const ctx = document.getElementById('chart').getContext('2d');
    let chart;

    // Načíst seznam souborů z index.json
    async function loadFileList() {
      try {
        const resp = await fetch('data/index.json');
        const files = await resp.json();
        const select = document.getElementById('fileSelect');
        select.innerHTML = '';

        // Aktuální měsíc (history.csv)
        const optCurrent = document.createElement('option');
        optCurrent.value = 'data/history.csv';
        optCurrent.textContent = 'Aktuální měsíc';
        select.appendChild(optCurrent);

        // Historické soubory
        files.forEach(f => {
          const opt = document.createElement('option');
          opt.value = 'data/' + f;
          opt.textContent = f.replace('history_', '').replace('.csv', '');
          select.appendChild(opt);
        });

        select.value = 'data/history.csv';
        loadCSV(select.value);
        select.addEventListener('change', () => loadCSV(select.value));
      } catch (err) {
        alert('Nepodařilo se načíst seznam souborů (index.json)');
        console.error(err);
      }
    }

    // Načíst CSV
    async function loadCSV(path) {
      try {
        const resp = await fetch(path);
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const text = await resp.text();

        const rows = text.trim().split('\n').slice(1); // přeskočíme hlavičku
        const labels = [];
        const temps = [];
        const hums = [];

        rows.forEach(line => {
          const [timestamp, source, temp, hum] = line.split(',');
          labels.push(timestamp);
          temps.push(parseFloat(temp));
          hums.push(parseFloat(hum || "NaN"));
        });

        updateChart(labels, temps, hums);
      } catch (err) {
        alert('Nepodařilo se načíst data (CSV)');
        console.error(err);
      }
    }

    // Aktualizovat graf
    function updateChart(labels, temps, hums) {
      const showTemp = document.getElementById('showTemp').checked;
      const showHumidity = document.getElementById('showHumidity').checked;

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Teplota (°C)',
              data: temps,
              borderColor: 'red',
              yAxisID: 'y',
              hidden: !showTemp
            },
            {
              label: 'Vlhkost (%)',
              data: hums,
              borderColor: 'blue',
              yAxisID: 'y1',
              hidden: !showHumidity
            }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          stacked: false,
          scales: {
            y: {
              type: 'linear',
              position: 'left',
              title: { display: true, text: 'Teplota (°C)' }
            },
            y1: {
              type: 'linear',
              position: 'right',
              title: { display: true, text: 'Vlhkost (%)' },
              grid: { drawOnChartArea: false }
            }
          }
        }
      });

      // Statistiky
      const validTemps = temps.filter(t => !isNaN(t));
      document.getElementById('minTemp').textContent = validTemps.length ? Math.min(...validTemps).toFixed(1) : '-';
      document.getElementById('maxTemp').textContent = validTemps.length ? Math.max(...validTemps).toFixed(1) : '-';
    }

    document.getElementById('showTemp').addEventListener('change', () => loadCSV(document.getElementById('fileSelect').value));
    document.getElementById('showHumidity').addEventListener('change', () => loadCSV(document.getElementById('fileSelect').value));

    loadFileList();
  </script>
</body>
</html>
