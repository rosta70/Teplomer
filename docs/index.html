<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meteo archiv ‚Äì jednoduch√Ω graf</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.js"></script>
  <style>
    /* ... tvoje p≈Øvodn√≠ CSS beze zmƒõn ... */
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Meteo archiv</h1>
    <div class="sub">Zdroj: <code>tmep.cz</code> ¬∑ CSV archiv ¬∑ lev√° osa ¬∞C, prav√° osa %</div>

    <div class="controls">
      <label class="chip"><input type="checkbox" id="showTemp" checked> Teplota (¬∞C)</label>
      <label class="chip"><input type="checkbox" id="showHum" checked> Vlhkost (%)</label>

      <div class="chip">
        Rozsah:
        <select id="range">
          <option value="all" selected>V≈°e</option>
          <option value="30d">Posledn√≠ch 30 dn√≠</option>
          <option value="7d">Posledn√≠ch 7 dn√≠</option>
          <option value="today">Dnes</option>
          <option value="custom">Vlastn√≠‚Ä¶</option>
        </select>
      </div>

      <div class="chip" id="customRange" style="display:none">
        <label>Od: <input type="date" id="fromDate"></label>
        <label>Do: <input type="date" id="toDate"></label>
        <button id="applyRange" type="button">Pou≈æ√≠t</button>
      </div>

      <!-- v√Ωbƒõr souboru (napln√≠ se dynamicky z index.json) -->
      <div class="chip">
        Soubor:
        <select id="fileSelect"></select>
      </div>

      <div class="chip srcs" id="srcToggles" title="Zap/vyp stanice"></div>

      <button id="theme">üåì Re≈æim</button>
      <a id="dlCsv" class="muted" href="#" download="history.csv">St√°hnout CSV</a>
    </div>

    <div class="stats">
      <div class="stat">
        <div class="label">Min. teplota (vybran√Ω rozsah)</div>
        <div class="val" id="tmin">‚Äì</div>
      </div>
      <div class="stat">
        <div class="label">Max. teplota (vybran√Ω rozsah)</div>
        <div class="val" id="tmax">‚Äì</div>
      </div>
    </div>

    <div class="chart">
      <canvas id="chart"></canvas>
      <div id="nodata" class="muted" style="padding:10px;display:none">≈Ω√°dn√° data pro zvolen√Ω filtr.</div>
    </div>
  </div>

<script>
(() => {
  const csvLink   = document.getElementById('dlCsv');
  const fileSelect= document.getElementById('fileSelect');

  // ---------- Naƒçten√≠ seznamu CSV z index.json ----------
  async function loadFileList() {
    try {
      const r = await fetch("data/index.json", { cache: "no-store" });
      if (!r.ok) throw new Error("index.json nenalezen");
      const list = await r.json();

      // naplnƒõn√≠ <select>
      fileSelect.innerHTML = "";
      list.forEach((file, i) => {
        const opt = document.createElement("option");
        opt.value = "data/" + file;
        opt.textContent = (file === "history.csv")
          ? "Aktu√°ln√≠ mƒõs√≠c"
          : file.replace("history_", "").replace(".csv", "");
        if (i === 0) opt.selected = true; // prvn√≠ polo≈æka
        fileSelect.appendChild(opt);
      });

      // spust√≠me naƒçten√≠ prvn√≠ho souboru
      reload(fileSelect.value);
    } catch (err) {
      console.error(err);
      alert("Nepoda≈ôilo se naƒç√≠st index.json se seznamem soubor≈Ø.");
    }
  }

  async function loadCsv(fileName) {
    const r = await fetch(fileName, { cache: 'no-store' });
    if (!r.ok) throw new Error('CSV soubor nenalezen: ' + fileName);
    csvLink.href = fileName;
    return await r.text();
  }

  // ---------- zbytek funkc√≠ parseCsv, buildLabels, rangeFilter, makeDatasets, updateExtremes... (beze zmƒõny) ----------

  let chart, RAW=[], sources=[], enabledSrc={}, currentRange='all', currentFrom='', currentTo='';

  async function reload(fileName) {
    try {
      const text = await loadCsv(fileName);
      RAW = parseCsv(text);
      sources = unique(RAW.map(r=>r.src)).sort();
      enabledSrc = {};
      const togglesEl = document.getElementById('srcToggles');
      togglesEl.innerHTML = '';
      sources.forEach(src => {
        enabledSrc[src]=true;
        const id='src_'+src.replace(/\W/g,'_');
        const lbl=document.createElement('label'); lbl.className='chip';
        lbl.innerHTML = `<input type="checkbox" id="${id}" data-src="${src}" checked> Stanice ${src}`;
        lbl.addEventListener('change', e => { enabledSrc[src] = e.target.checked; redraw(); });
        togglesEl.appendChild(lbl);
      });
      redraw();
    } catch(err) {
      console.error(err);
      alert('Nepoda≈ôilo se naƒç√≠st data: '+fileName);
    }
  }
  window.reload = reload;
  window.redraw = redraw;

  // ---------- eventy ----------
  fileSelect.addEventListener("change", () => reload(fileSelect.value));

  // ---------- start ----------
  loadFileList(); // <- naƒçteme seznam z index.json
})();
</script>
</body>
</html>
