<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Meteo archiv</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f9; margin:0; padding:0; }
    header { background:#334155; color:white; padding:10px 16px; }
    h1 { margin:0; font-size:1.2rem; }
    .wrap { max-width:1100px; margin:0 auto; padding:12px; }
    .controls { display:flex; flex-wrap:wrap; gap:.6rem; margin-bottom:.8rem; }
    .group { display:flex; gap:.6rem; align-items:center; background:#fff; padding:6px 10px; border-radius:8px; border:1px solid #ccc; }
    label { display:flex; align-items:center; gap:.35rem; font-size:.9rem; }
    input[type="checkbox"] { width:18px; height:18px; }
    select,input,button { font-size:.9rem; padding:6px 8px; }
    #customRange { display:none; gap:.6rem; }
    .stats { display:flex; flex-wrap:wrap; gap:.6rem; margin:.8rem 0; }
    .stat { flex:1 1 260px; background:#fff; padding:10px; border-radius:8px; border:1px solid #ccc; }
    .stat .ttl { color:#64748b; font-size:.85rem; margin-bottom:4px; }
    .stat .val { font-size:1.2rem; font-weight:bold; }
    .stat .sub { font-size:.8rem; color:#64748b; }
    .chart-card { background:#fff; padding:10px; border-radius:8px; border:1px solid #ccc; }
    canvas { width:100%; height:420px; }
    #rangeBadge { font-size:.85rem; color:#475569; }
  </style>
</head>
<body>
  <header><h1>Meteo archiv</h1></header>
  <div class="wrap">
    <div class="controls">
      <div class="group">
        <label><input id="chkTemp" type="checkbox" checked> Teplota (°C)</label>
        <label><input id="chkHum" type="checkbox" checked> Vlhkost (%)</label>
      </div>

      <div class="group">
        <select id="selRange">
          <option value="today" selected>Dnešek</option>
          <option value="week">Týden</option>
          <option value="month">Měsíc</option>
          <option value="all">Vše</option>
          <option value="custom">Vlastní…</option>
        </select>
        <select id="selFile"></select>
        <button id="btnReset">Reset zoom</button>
      </div>
    </div>

    <div class="controls" id="customRange">
      <label>Od: <input type="datetime-local" id="fromDate"></label>
      <label>Do: <input type="datetime-local" id="toDate"></label>
      <button id="applyRange" type="button">Použít</button>
    </div>

    <div class="controls">
      <div id="sensorBox"></div>
      <span id="rangeBadge"></span>
    </div>

    <div class="stats">
      <div class="stat"><div class="ttl">Min. teplota</div><div class="val" id="minVal">–</div><div class="sub" id="minInfo">–</div></div>
      <div class="stat"><div class="ttl">Max. teplota</div><div class="val" id="maxVal">–</div><div class="sub" id="maxInfo">–</div></div>
    </div>

    <div class="chart-card"><canvas id="chart"></canvas></div>
  </div>

<script>
const SENSOR_LABEL = { "4065":"UNI", "2764":"Venek" };
const $ = s=>document.querySelector(s);
let allRows=[],visibleSensors=new Set(),chart;

async function fetchJSON(paths){for(const p of paths){try{const r=await fetch(p,{cache:"no-store"});if(r.ok)return await r.json();}catch{}}throw new Error("index.json nenalezen");}
async function fetchText(paths){for(const p of paths){try{const r=await fetch(p,{cache:"no-store"});if(r.ok)return await r.text();}catch{}}throw new Error("CSV nenalezeno");}

async function loadIndex(){
  const files=await fetchJSON(["data/index.json","docs/data/index.json"]);
  const sel=$("#selFile"); sel.innerHTML="";
  files.forEach(f=>{const o=document.createElement("option");o.value=f;o.textContent=f;sel.appendChild(o);});
  if(files.includes("history.csv")) sel.value="history.csv";
  await loadCSV();
}

async function loadCSV(){
  const f=$("#selFile").value;
  const text=await fetchText([`data/${f}`,`docs/data/${f}`]);
  const lines=text.trim().split(/\r?\n/);
  let start=0;if(lines[0].toLowerCase().includes("timestamp"))start=1;
  allRows=[];for(let i=start;i<lines.length;i++){const [ts,id,t,h]=lines[i].split(",");if(!ts||!id)continue;const time=new Date(ts);allRows.push({time,id,temp:parseFloat(t),hum:parseFloat(h)});}
  const ids=[...new Set(allRows.map(r=>r.id))].sort();visibleSensors=new Set(ids);renderSensorToggles(ids);update();
}

function renderSensorToggles(ids){
  const box=$("#sensorBox");box.innerHTML="";
  ids.forEach(id=>{const l=document.createElement("label");l.innerHTML=`<input type="checkbox" data-id="${id}" checked> ${SENSOR_LABEL[id]??id}`;l.querySelector("input").addEventListener("change",e=>{if(e.target.checked)visibleSensors.add(id);else visibleSensors.delete(id);update();});box.appendChild(l);});
}

function filterByRange(rows){
  const range=$("#selRange").value;
  const now=new Date();let from,to=now;
  if(range==="today"){from=new Date(now.getFullYear(),now.getMonth(),now.getDate());}
  else if(range==="week"){from=new Date(now.getTime()-7*864e5);}
  else if(range==="month"){from=new Date(now.getTime()-31*864e5);}
  else if(range==="custom"){
    const fromVal=$("#fromDate").value,toVal=$("#toDate").value;
    if(fromVal&&toVal){from=new Date(fromVal);to=new Date(toVal);} }
  const out=rows.filter(r=>(!from||r.time>=from)&&(!to||r.time<=to));
  $("#rangeBadge").textContent=`Zobrazeno: ${from?from.toLocaleString():"–"} — ${to?to.toLocaleString():"–"}`;
  return out;
}

function update(){
  const rows=filterByRange(allRows).filter(r=>visibleSensors.has(r.id));
  const tRows=rows.filter(r=>Number.isFinite(r.temp));
  if(tRows.length){const min=tRows.reduce((a,b)=>b.temp<a.temp?b:a);const max=tRows.reduce((a,b)=>b.temp>a.temp?b:a);$("#minVal").textContent=`${min.temp.toFixed(2)} °C`;$("#maxVal").textContent=`${max.temp.toFixed(2)} °C`;$("#minInfo").textContent=`${SENSOR_LABEL[min.id]??min.id}, ${min.time.toLocaleString()}`;$("#maxInfo").textContent=`${SENSOR_LABEL[max.id]??max.id}, ${max.time.toLocaleString()}`;}
  const ids=[...new Set(rows.map(r=>r.id))].sort();const datasets=[];ids.forEach(id=>{const srows=rows.filter(r=>r.id===id);datasets.push({label:`${SENSOR_LABEL[id]??id} (°C)`,data:srows.map(r=>({x:r.time,y:r.temp})),yAxisID:"yT",borderColor:id==="4065"?"#ef4444":"#3b82f6",tension:.2,pointRadius:0});datasets.push({label:`${SENSOR_LABEL[id]??id} (%)`,data:srows.map(r=>({x:r.time,y:r.hum})),yAxisID:"yH",borderColor:id==="4065"?"#f97316":"#22d3ee",tension:.2,pointRadius:0,borderDash:[6,4]});});drawChart(datasets);
}

function drawChart(datasets){
  const ctx=$("#chart").getContext("2d");if(chart)chart.destroy();
  chart=new Chart(ctx,{type:"line",data:{datasets},options:{responsive:true,interaction:{mode:"nearest",axis:"x",intersect:false},scales:{x:{type:"time",time:{tooltipFormat:"dd.MM.yyyy HH:mm"},ticks:{autoSkip:true,maxTicksLimit:7}},yT:{title:{display:true,text:"°C"}},yH:{position:"right",title:{display:true,text:"%"},suggestedMin:0,suggestedMax:100}},plugins:{zoom:{zoom:{wheel:{enabled:true},pinch:{enabled:true},mode:"x"},pan:{enabled:true,mode:"x"}}}});}

$("#selFile").addEventListener("change", loadCSV);
$("#selRange").addEventListener("change", e=>{if(e.target.value==="custom")$("#customRange").style.display="flex";else $("#customRange").style.display="none";update();});
$("#applyRange").addEventListener("click", update);
$("#chkTemp").addEventListener("change", update);
$("#chkHum").addEventListener("change", update);
$("#btnReset").addEventListener("click", ()=>chart&&chart.resetZoom());

loadIndex().catch(err=>{console.error(err);alert("Nepodařilo se načíst data (index.json).");});
</script>
</body>
</html>
