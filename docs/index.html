<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Meteo archiv</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Date picker -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <style>
    body.dark {
      background-color: #121212;
      color: #f1f1f1;
    }
    .card {
      margin-bottom: 1rem;
    }
    #chartContainer {
      height: 500px;
    }
  </style>
</head>
<body class="light">

<div class="container my-4">
  <h2 class="mb-3">Meteo archiv</h2>
  <p><strong>Zdroj:</strong> <em>brrr.cz</em> • CSV z GitHub Pages</p>

  <!-- Ovládací panel -->
  <div class="row g-2 mb-3">
    <div class="col-auto">
      <input type="checkbox" id="showTemp" checked>
      <label for="showTemp">Teplota (°C)</label>
    </div>
    <div class="col-auto">
      <input type="checkbox" id="showHum" checked>
      <label for="showHum">Vlhkost (%)</label>
    </div>
    <div class="col-auto">
      <select id="rangeSelect" class="form-select">
        <option value="all">Vše</option>
        <option value="today">Dnes</option>
        <option value="week">Týden</option>
        <option value="month">Měsíc</option>
        <option value="custom">Vlastní rozsah</option>
      </select>
    </div>
    <div class="col-auto">
      <select id="fileSelect" class="form-select"></select>
    </div>
    <div class="col-auto">
      <button id="toggleMode" class="btn btn-secondary">Režim</button>
    </div>
    <div class="col-auto">
      <button id="downloadCSV" class="btn btn-primary">Stáhnout CSV</button>
    </div>
    <div class="col-auto">
      <button id="downloadPNG" class="btn btn-success">Stáhnout PNG</button>
    </div>
  </div>

  <!-- Volba čidel -->
  <div id="sensorCheckboxes" class="mb-3"></div>

  <!-- Statistika -->
  <div class="row mb-3">
    <div class="col-md-6">
      <div class="card p-2">
        <strong>Min. teplota (vybraný rozsah)</strong>
        <div id="minTemp">–</div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card p-2">
        <strong>Max. teplota (vybraný rozsah)</strong>
        <div id="maxTemp">–</div>
      </div>
    </div>
  </div>

  <!-- Graf -->
  <div class="card">
    <div class="card-body">
      <canvas id="chart"></canvas>
    </div>
  </div>
</div>

<script>
let chart;
let allData = [];
let sensors = {};

async function loadFileList() {
  try {
    const res = await fetch("data/index.json");
    const files = await res.json();
    const select = document.getElementById("fileSelect");
    select.innerHTML = "";
    files.forEach(file => {
      const opt = document.createElement("option");
      opt.value = file;
      opt.textContent = file;
      select.appendChild(opt);
    });
    select.value = "history.csv";
    await loadData(select.value);
  } catch (err) {
    alert("Nepodařilo se načíst index.json");
    console.error(err);
  }
}

async function loadData(file) {
  try {
    const res = await fetch("data/" + file);
    const text = await res.text();
    const rows = text.trim().split("\n").slice(1); // přeskočit hlavičku
    allData = rows.map(line => {
      const [timestamp, source, temp, hum] = line.split(",");
      return {
        time: new Date(timestamp),
        source,
        temp: parseFloat(temp),
        hum: parseFloat(hum)
      };
    });
    sensors = {};
    allData.forEach(r => { sensors[r.source] = true; });
    renderSensorCheckboxes();
    updateChart();
  } catch (err) {
    alert("Nepodařilo se načíst data (CSV).");
    console.error(err);
  }
}

function renderSensorCheckboxes() {
  const div = document.getElementById("sensorCheckboxes");
  div.innerHTML = "";
  Object.keys(sensors).forEach(s => {
    const id = "sensor_" + s;
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.id = id;
    cb.checked = true;
    cb.onchange = updateChart;
    const lbl = document.createElement("label");
    lbl.htmlFor = id;
    lbl.textContent = s;
    div.appendChild(cb);
    div.appendChild(lbl);
    div.appendChild(document.createTextNode(" "));
  });
}

function filterData() {
  const range = document.getElementById("rangeSelect").value;
  let fromDate;
  const now = new Date();
  if (range === "today") {
    fromDate = new Date(); fromDate.setHours(0,0,0,0);
  } else if (range === "week") {
    fromDate = new Date(); fromDate.setDate(now.getDate()-7);
  } else if (range === "month") {
    fromDate = new Date(); fromDate.setMonth(now.getMonth()-1);
  }
  return allData.filter(r => {
    if (fromDate) return r.time >= fromDate;
    return true;
  });
}

function updateChart() {
  const data = filterData();
  const showTemp = document.getElementById("showTemp").checked;
  const showHum = document.getElementById("showHum").checked;
  const datasets = [];
  const selectedSensors = Object.keys(sensors).filter(s => document.getElementById("sensor_"+s).checked);

  selectedSensors.forEach(s => {
    if (showTemp) {
      datasets.push({
        label: s + " (°C)",
        data: data.filter(r => r.source===s).map(r => ({x:r.time,y:r.temp})),
        borderColor: "red",
        backgroundColor: "rgba(255,0,0,0.2)",
        yAxisID: "y"
      });
    }
    if (showHum) {
      datasets.push({
        label: s + " (%)",
        data: data.filter(r => r.source===s).map(r => ({x:r.time,y:r.hum})),
        borderColor: "blue",
        backgroundColor: "rgba(0,0,255,0.2)",
        yAxisID: "y1"
      });
    }
  });

  if (chart) chart.destroy();
  chart = new Chart(document.getElementById("chart"), {
    type: "line",
    data: { datasets },
    options: {
      responsive: true,
      interaction: { mode: "nearest", axis: "x", intersect: false },
      stacked: false,
      scales: {
        x: { type: "time", time: { unit: "hour" } },
        y: { type: "linear", position: "left", title:{display:true,text:"°C"} },
        y1: { type: "linear", position: "right", title:{display:true,text:"%"}, grid:{drawOnChartArea:false} }
      }
    }
  });

  // aktualizace statistik
  const temps = data.map(r=>r.temp).filter(v=>!isNaN(v));
  document.getElementById("minTemp").textContent = temps.length? Math.min(...temps).toFixed(1)+" °C":"–";
  document.getElementById("maxTemp").textContent = temps.length? Math.max(...temps).toFixed(1)+" °C":"–";
}

document.getElementById("rangeSelect").onchange = updateChart;
document.getElementById("fileSelect").onchange = e => loadData(e.target.value);
document.getElementById("toggleMode").onclick = () => {
  document.body.classList.toggle("dark");
};
document.getElementById("downloadCSV").onclick = () => {
  const csv = "timestamp,source,temp_c,humidity_pct\n" + allData.map(r =>
    `${r.time.toISOString()},${r.source},${r.temp},${r.hum}`).join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "data.csv";
  a.click();
};
document.getElementById("downloadPNG").onclick = () => {
  const a = document.createElement("a");
  a.href = chart.toBase64Image();
  a.download = "chart.png";
  a.click();
};

loadFileList();
</script>

</body>
</html>
