<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Meteo archiv</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: system-ui, sans-serif; }
    .dark-mode { background-color: #0f172a; color: #e2e8f0; }
    .dark-mode .card { background: #1e293b; color: #e2e8f0; }
    .card { background: white; border-radius: 0.75rem; padding: 1rem; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .btn { padding: 0.4rem 0.8rem; border-radius: 0.5rem; font-weight: 500; cursor: pointer; }
    .btn-blue { background: #3b82f6; color: white; }
    .btn-green { background: #10b981; color: white; }
    .btn:hover { opacity: 0.9; }
  </style>
</head>
<body class="p-6 bg-gray-50 dark-mode-transition">
  <h1 class="text-3xl font-bold mb-2">Meteo archiv</h1>
  <p class="mb-4 text-gray-600 dark:text-gray-300">
    Zdroj: <b>brrr.cz</b> · CSV z GitHub Pages
  </p>

  <!-- Ovládací panel -->
  <div class="flex flex-wrap items-center gap-3 mb-6">
    <label><input type="checkbox" id="showTemp" checked> Teplota (°C)</label>
    <label><input type="checkbox" id="showHum" checked> Vlhkost (%)</label>

    <select id="rangeSelect" class="border rounded p-1">
      <option value="all">Vše</option>
      <option value="day">Dnes</option>
      <option value="week">Týden</option>
      <option value="month">Měsíc</option>
    </select>

    <select id="fileSelect" class="border rounded p-1"></select>

    <button id="toggleDark" class="btn btn-blue">Režim</button>
    <button id="downloadCSV" class="btn btn-blue">Stáhnout CSV</button>
    <button id="downloadPNG" class="btn btn-green">Stáhnout PNG</button>
  </div>

  <!-- Statistiky -->
  <div class="grid grid-cols-2 gap-4 mb-6">
    <div class="card">
      <div>Min. teplota (vybraný rozsah)</div>
      <div id="minTemp" class="text-xl font-bold">–</div>
    </div>
    <div class="card">
      <div>Max. teplota (vybraný rozsah)</div>
      <div id="maxTemp" class="text-xl font-bold">–</div>
    </div>
  </div>

  <!-- Graf -->
  <div class="card">
    <canvas id="chart" height="120"></canvas>
  </div>

  <script>
    const ctx = document.getElementById('chart').getContext('2d');
    let chart;

    // Přepínání tmavého/světlého režimu
    const body = document.body;
    if (localStorage.getItem('theme') === 'dark') {
      body.classList.add('dark-mode');
    }
    document.getElementById('toggleDark').onclick = () => {
      body.classList.toggle('dark-mode');
      localStorage.setItem('theme', body.classList.contains('dark-mode') ? 'dark' : 'light');
    };

    // Načíst seznam souborů z index.json
    fetch('index.json')
      .then(r => r.json())
      .then(files => {
        const select = document.getElementById('fileSelect');
        files.forEach(f => {
          const opt = document.createElement('option');
          opt.value = f;
          opt.textContent = f.replace('history', '').replace('.csv','') || 'Aktuální';
          select.appendChild(opt);
        });
        select.value = "history.csv"; // default
        loadCSV(select.value);
        select.onchange = () => loadCSV(select.value);
      });

    // Funkce pro načítání CSV
    function loadCSV(file) {
      fetch(file)
        .then(r => r.text())
        .then(text => {
          const data = Papa.parse(text, { header: true, skipEmptyLines: true }).data;
          drawChart(data);
        })
        .catch(() => alert("Nepodařilo se načíst data (CSV)."));
    }

    // Funkce pro vykreslení grafu
    function drawChart(data) {
      const showTemp = document.getElementById('showTemp').checked;
      const showHum = document.getElementById('showHum').checked;

      const times = data.map(r => new Date(r.timestamp));
      const temps = data.map(r => parseFloat(r.temp_c));
      const hums  = data.map(r => parseFloat(r.humidity_pct));

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: times,
          datasets: [
            ...(showTemp ? [{
              label: "Teplota (°C)",
              data: temps,
              borderColor: "red",
              backgroundColor: "rgba(255,0,0,0.2)",
              yAxisID: "yT"
            }] : []),
            ...(showHum ? [{
              label: "Vlhkost (%)",
              data: hums,
              borderColor: "blue",
              backgroundColor: "rgba(0,0,255,0.2)",
              yAxisID: "yH"
            }] : [])
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: "index", intersect: false },
          stacked: false,
          plugins: { legend: { position: 'top' } },
          scales: {
            x: { type: "time", time: { unit: "hour" } },
            yT: { type: "linear", position: "left", title: { display: true, text: "°C" } },
            yH: { type: "linear", position: "right", title: { display: true, text: "%" }, grid: { drawOnChartArea: false } }
          }
        }
      });

      // Statistiky
      const min = Math.min(...temps.filter(v => !isNaN(v)));
      const max = Math.max(...temps.filter(v => !isNaN(v)));
      document.getElementById('minTemp').textContent = isFinite(min) ? min.toFixed(1) + " °C" : "–";
      document.getElementById('maxTemp').textContent = isFinite(max) ? max.toFixed(1) + " °C" : "–";
    }

    // Přepočítat graf při změně checkboxů
    document.getElementById('showTemp').onchange = () => loadCSV(document.getElementById('fileSelect').value);
    document.getElementById('showHum').onchange = () => loadCSV(document.getElementById('fileSelect').value);

    // Exporty
    document.getElementById('downloadCSV').onclick = () => {
      const file = document.getElementById('fileSelect').value;
      window.open(file, "_blank");
    };
    document.getElementById('downloadPNG').onclick = () => {
      const a = document.createElement("a");
      a.href = chart.toBase64Image();
      a.download = "chart.png";
      a.click();
    };
  </script>
</body>
</html>
