<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Meteo archiv</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js"></script>
  <style>
    /* Původní Téma: Oceanic Dark (Výchozí) */
    :root, .theme-dark {
      --bg: #0f1115;
      --card: #171a21;
      --muted: #9aa4b2;
      --text: #e7edf4;
      --accent: #2dd4bf;
      --danger: #f43f5e;
      --info: #60a5fa;
      --chart-bg: #171a21; 
      --chart-legend-text: #e7edf4; 
    }

    /* Téma 2: Křišťálově bílé (Crystal Light) */
    .theme-light {
      --bg: #f8f8f8;
      --card: #ffffff;
      --muted: #6b7280;
      --text: #1f2937;
      --accent: #10b981;
      --danger: #dc2626;
      --info: #3b82f6;
      --chart-bg: #f5f5f5;
      --chart-legend-text: #111;
    }

    /* Téma 3: Černá a Bílá (Monochrome) */
    .theme-mono {
      --bg: #000000;
      --card: #111111;
      --muted: #aaaaaa;
      --text: #ffffff;
      --accent: #22c55e;
      --danger: #ef4444;
      --info: #3b82f6;
      --chart-bg: #111111; 
      --chart-legend-text: #ffffff; 
    }


    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;}
    
    /* UPRAVENO: Záhlaví pro vycentrování nadpisu */
    header {
        display: flex;
        align-items: center;
        padding: 14px 18px;
        border-bottom: 1px solid #222;
        justify-content: space-between; /* Rozprostře logo na začátek, nadpis na střed */
        position: relative; /* Pro absolutní pozicování nadpisu */
    }

    /* NOVÉ LOGO: Teploměr/Teplota */
    header .logo {
        width: 22px;
        height: 22px;
        background: linear-gradient(to top, var(--danger) 0%, var(--danger) 50%, var(--info) 50%, var(--info) 100%); /* Červená dole, modrá nahoře */
        border-radius: 50%; /* Udělá to kruh */
        box-shadow: 0 0 0 2px var(--card);
        position: relative; 
        overflow: hidden; 
        z-index: 10; 
    }
    header .logo::before {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 60%;
        height: 80%; 
        background: var(--text); 
        border-radius: 0 0 50% 50%; 
        z-index: 1;
        opacity: 0.15;
    }

    /* UPRAVENO: Centrování H1 a Mobile Fix */
    header h1 {
        position: absolute;
        left: 50%;
        transform: translateX(-50%); 
        margin: 0; 
        font-size: 1.4rem;
        font-weight: 600;
        white-space: nowrap; 
    }

    main{max-width:1200px;margin:1rem auto;padding:0 18px;}
    .controls{display:flex;flex-wrap:wrap;gap:12px;padding:14px 0;border-bottom:1px solid var(--card);}
    .controls-group{display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
    .controls label{display:flex;gap:6px;align-items:center;}
    select, input[type=date]{background:var(--card);color:var(--text);border:1px solid #333;padding:6px 10px;border-radius:6px;}
    button{background:var(--card);color:var(--text);border:1px solid #333;padding:6px 10px;border-radius:6px;cursor:pointer;transition:background .1s;}
    button:hover{background:#333;}
    /* UPRAVENO: Grid pro statistiky a jejich karty */
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;padding:14px 0;}
    .stat-card{background:var(--card);padding:14px;border-radius:8px;box-shadow:0 4px 6px -1px rgba(0,0,0,.1); transition: box-shadow 0.3s;}
    .stat-card:hover{box-shadow:0 0 10px rgba(45, 212, 191, 0.4);}
    .stat-title{color:var(--muted);font-size:.8rem;font-weight:500;margin-bottom:4px;}
    .stat-value{font-size:1.5rem;font-weight:700;}
    .stat-group{display:flex;justify-content:space-between;align-items:baseline;margin-top:6px; flex-wrap: wrap;}
    .stat-detail{color:var(--muted); font-size: .85rem;}
    .stat-temp{color:var(--danger);}
    .stat-hum{color:var(--info);}
    .toggles{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0;}
    .toggle{padding:4px 10px;border-radius:20px;font-size:.9rem;cursor:pointer;background:var(--card);border:1px solid #333;transition:background .1s;}
    .toggle.active{background:var(--accent);border-color:var(--accent);color:var(--bg);font-weight:600;}
    .chart-container{padding:14px 0;}
    .custom-range-inputs{display:none;gap:12px;margin-top:12px;}
    .error-message{color:var(--danger);padding:10px;background:rgba(244,63,94,.1);border-radius:6px;border:1px solid var(--danger);margin-top:1rem;display:none;}
    
    /* TŘÍDY PRO ZVÝRAZNĚNÍ STATISTIK */
    .stat-max-temp{color: var(--danger); font-weight: 600;}
    .stat-min-temp{color: var(--info); font-weight: 600;}
    .stat-max-hum{color: var(--accent);} 
    .stat-min-hum{color: var(--muted);} 

    /* === VYLEPŠENÍ MOBILITY === */
    @media (max-width: 700px) {
        main {padding: 0 12px;} 
        
        /* Hlavní kontejner ovládání je vertikální */
        .controls {
            flex-direction: column; 
            gap: 16px; 
        }
        
        /* Každá skupina zabere plnou šířku a zalamuje se */
        .controls-group {
            width: 100%; 
            flex-wrap: wrap; 
            justify-content: space-between;
            gap: 8px; 
        }
        
        /* Selektory a Inputy se roztáhnou a vyplní řádek rovnoměrně */
        .controls-group select,
        .controls-group input[type=datetime-local],
        .controls-group input[type=text],
        .controls-group .custom-range-inputs input {
            flex-grow: 1; 
            min-width: 120px;
        }

        /* Tlačítka se nemusí tak moc roztahovat (pro hezčí seskupení) */
        .controls-group button {
            flex-grow: 0; 
            min-width: 100px;
        }
    }

  </style>
</head>
<body class="theme-dark">
  <header>
    <div class="logo"></div>
    <h1>Meteo Archiv</h1>
  </header>
  <main>
    <div class="controls">
      <div class="controls-group">
        <label for="selFile">Archiv:</label>
        <select id="selFile"></select>
      </div>
      <div class="controls-group">
        <label for="selRange">Zobrazit:</label>
        <select id="selRange">
          <option value="today" selected>Dnes</option>
          <option value="yesterday">Včera</option>
          <option value="last7">Posledních 7 dní</option>
          <option value="last30">Posledních 30 dní</option>
          <option value="all">Celý soubor</option>
          <option value="custom">Vlastní rozsah</option>
        </select>
        
        <select id="selJumpTime" title="Rychlý skok na čas" style="display: none;"> 
            <option value="">Skok na čas...</option>
            <option value="00">0:00</option>
            <option value="01">1:00</option>
            <option value="02">2:00</option>
            <option value="03">3:00</option>
            <option value="04">4:00</option>
            <option value="05">5:00</option>
            <option value="06">6:00</option>
            <option value="07">7:00</option>
            <option value="08">8:00 (Ráno)</option>
            <option value="09">9:00</option>
            <option value="10">10:00</option>
            <option value="11">11:00</option>
            <option value="12">12:00 (Poledne)</option>
            <option value="13">13:00</option>
            <option value="14">14:00</option>
            <option value="15">15:00</option>
            <option value="16">16:00</option>
            <option value="17">17:00</option>
            <option value="18">18:00 (Večer)</option>
            <option value="19">19:00</option>
            <option value="20">20:00</option>
            <option value="21">21:00</option>
            <option value="22">22:00 (Noc)</option>
            <option value="23">23:00</option>
        </select>
        
        <div id="customRangeInputs" class="custom-range-inputs">
          <input type="datetime-local" id="dateFrom" title="Datum a čas Od" />
          <input type="datetime-local" id="dateTo" title="Datum a čas Do" />
        </div>
      </div>
      <div class="controls-group">
        <label for="chkTemp"><input type="checkbox" id="chkTemp" checked />Teplota</label>
        <label for="chkHum"><input type="checkbox" id="chkHum" />Vlhkost</label>
      </div>
      <div class="controls-group">
        <button id="btnReset" title="Resetovat zoom">Reset Zoom</button>
        <button id="btnCsv" title="Stáhnout data ve formátu CSV">CSV</button>
        <button id="btnPng" title="Uložit graf jako PNG obrázek">PNG</button>
      </div>
      <div class="controls-group">
        <label for="selTheme">Téma:</label>
        <select id="selTheme">
          <option value="theme-dark">Oceanic Dark</option>
          <option value="theme-light">Crystal Light</option>
          <option value="theme-mono">Monochrome</option>
        </select>
      </div>
    </div>

    <div id="errorMessage" class="error-message"></div>

    <div class="toggles" id="sensorToggles">
      </div>

    <div class="chart-container">
      <canvas id="meteoChart"></canvas>
    </div>

    <div class="stats" id="statsContainer">
      </div>
  </main>

  <script>
    // Zjednodušená verze document.querySelector
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    const $selRange = $("#selRange");
    const $dateFrom = $("#dateFrom");
    const $dateTo = $("#dateTo");
    const $selTheme = $("#selTheme");
    const $selJumpTime = $("#selJumpTime");

    // --- Pomocné ---
    // Mapování ID senzoru (ze sloupce 'source' v CSV) na popisek pro web
    const SENSOR_LABEL = { "UNI": "UNI", "Venek": "Venek", "Doma": "Doma" };

    // Centrální definice barev pro každý senzor a typ dat
    const SENSOR_COLORS = {
        "UNI": {
            temp: "#f43f5e",   // Malinově červená (UNI Teplota)
            hum:  "#fda4af"    // Světle růžová (UNI Vlhkost)
        },
        "Venek": {
            temp: "#2563eb",   // Intenzivní modrá (Venek Teplota)
            hum:  "#93c5fd"    // Světle modrá (Venek Vlhkost)
        },
        "Doma": {
            temp: "#059669",   // Tmavě zelená (Doma Teplota)
            hum:  "#6ee7b7"    // Světle zelená (Doma Vlhkost)
        },
        "Terasa": { // Příklad pro budoucí senzor
            temp: "#a855f7",   // Fialová (Terasa Teplota)
            hum:  "#d8b4fe"    // Světle fialová (Terasa Vlhkost)
        }
    };
    
    let data = [];
    let chart = null;

    function formatTime(t) {
      // Vrací čas a datum pro statistiky
      return t.toLocaleString("cs-CZ", { dateStyle: "short", timeStyle: "short" });
    }

    function formatDateForInput(d) {
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Načte seznam dostupných CSV souborů
    async function loadIndex() {
      const file = "index.json";
      try {
        // Používáme nejjednodušší relativní cestu
        const r = await fetch(`data/${file}`); 
        if (!r.ok) {
          // Pokud selže jednoduchá cesta, zkusíme záložní cestu
          const backupR = await fetch(`docs/data/${file}`);
          if (backupR.ok) {
              return loadIndexFromResponse(backupR);
          }
          throw new Error(`Chyba při načítání ${file} (Status ${r.status})`);
        }
        
        return loadIndexFromResponse(r);
        
      } catch (err) {
        $("#errorMessage").textContent = `Kritická chyba: Nepodařilo se načíst index.json. Zkontrolujte cestu a nasazení souboru.`;
        $("#errorMessage").style.display = "block";
      }
    }

    // Pomocná funkce pro zpracování odpovědi z index.json
    async function loadIndexFromResponse(response) {
        const index = await response.json();
        const selFile = $("#selFile");
        selFile.innerHTML = "";
        index.forEach(f => {
          const opt = document.createElement("option");
          opt.value = f;
          opt.textContent = f;
          selFile.appendChild(opt);
        });
        await loadCSV();
        
        $selRange.value = "today"; // Nastavíme Dnes jako výchozí
        toggleJumpTime(); // Zobrazí/skryje menu
        update();
    }


    // Načte vybraný CSV soubor
    async function loadCSV() {
      const f = $("#selFile").value;
      const fileUrl = `data/${f}`; 
      $("#errorMessage").style.display = "none";
      
      try {
        const r = await fetch(fileUrl);
        if (!r.ok) {
          // Zkusíme záložní cestu pro CSV, pokud selže
          const backupUrl = `docs/data/${f}`;
          const backupR = await fetch(backupUrl);
          if (backupR.ok) {
              return loadCSVFromResponse(backupR);
          }
          throw new Error(`Soubor ${fileUrl} nenalezen (Status: ${r.status}).`);
        }
        
        return loadCSVFromResponse(r);

      } catch (err) {
        $("#errorMessage").textContent = `Chyba při načítání dat: ${err.message}`;
        $("#errorMessage").style.display = "block";
        data = []; // Vyčistit data při chybě
        update();
      }
    }

    // Pomocná funkce pro zpracování odpovědi CSV
    async function loadCSVFromResponse(response) {
        const csvText = await response.text();
        data = parseCSV(csvText);
        
        renderSensorToggles(data);
        update();
    }
    
    // Zpracování CSV dat
    function parseCSV(csv) {
      const lines = csv.trim().split('\n').filter(line => line.trim() !== '');
      if (lines.length === 0) return [];
      
      const header = lines[0].split(',').map(h => h.trim());
      const records = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',');
        if (values.length !== header.length) continue;

        const record = {
          time: new Date(values[0].trim()),
          id: values[1].trim(), // Toto nyní obsahuje textové ID ("UNI", "Venek", "Doma")
          temp: parseFloat(values[2].trim()) || null,
          hum: parseFloat(values[3].trim()) || null,
        };
        records.push(record);
      }
      return records.sort((a, b) => a.time - b.time); // Seřazení pro Chart.js
    }
    
    // Přepínání zobrazení Vlastního rozsahu
    function toggleCustomRangeInputs() {
        const isCustom = $selRange.value === 'custom';
        $("#customRangeInputs").style.display = isCustom ? 'flex' : 'none';
        
        if (isCustom && !$dateFrom.value && data.length > 0) {
            const firstDate = data[0].time;
            const lastDate = data[data.length - 1].time;
            
            $dateFrom.value = formatDateForInput(firstDate);
            $dateTo.value = formatDateForInput(lastDate);
        }
    }


    // Filtrování dat na základě rozsahu (OPRAVENO: Podpora datetime-local)
    function filterData(data) {
      if (data.length === 0) return [];
      
      let startDate, endDate;
      const now = new Date();
      const range = $selRange.value;

      // 1. Nastavení data podle předvolby
      switch (range) {
        case 'today':
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          endDate = now; // Výchozí konec je teď
          break;
        case 'yesterday':
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
          endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()); 
          break;
        case 'last7':
          startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
          endDate = now;
          break;
        case 'last30':
          startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
          endDate = now;
          break;
        case 'custom':
          // KLÍČOVÁ ZMĚNA: Převádíme přímo hodnoty z datetime-local
          if ($dateFrom.value) startDate = new Date($dateFrom.value);
          if ($dateTo.value) endDate = new Date($dateTo.value);
          
          if (!startDate || !endDate || startDate.getTime() >= endDate.getTime() || isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
            // Kontrola platnosti a smysluplnosti rozsahu
            console.warn("Vlastní rozsah je neplatný nebo nesmyslný. Zobrazen celý soubor.");
            return data;
          }
          // Není potřeba setHours, protože datetime-local už obsahuje čas.
          break;
        case 'all':
        default:
          return data; 
      }
      
      // 2. Logika pro Skok na čas (platí jen pro "Dnes")
      const selectedHour = $selJumpTime.value;
      if (range === 'today' && selectedHour !== "") {
          const hour = parseInt(selectedHour);
          if (!isNaN(hour)) {
              // Nastavíme konec rozsahu na DNEŠNÍ den a zvolenou hodinu
              endDate = new Date(startDate.getTime()); // Kopírujeme datum (začátek dneška)
              endDate.setHours(hour, 59, 59, 999); // Nastavíme hodinu a konec minuty
          }
      }

      // Filtrování a zohlednění časové zóny
      return data.filter(r => r.time >= startDate && r.time <= endDate);
    }

    // Statistické výpočty
    function calculateStats(rows) {
      const sensorIds = [...new Set(rows.map(r => r.id))];
      const stats = {};

      sensorIds.forEach(id => {
        const srows = rows.filter(r => r.id === id);
        if (srows.length === 0) return;

        const temps = srows.filter(r => r.temp !== null);
        const hums = srows.filter(r => r.hum !== null);
        
        // --- VÝPOČET TEPLOTY ---
        const minT = temps.length ? temps.reduce((a, b) => b.temp < a.temp ? b : a) : null;
        const maxT = temps.length ? temps.reduce((a, b) => b.temp > a.temp ? b : a) : null;
        const sumT = temps.reduce((acc, r) => acc + r.temp, 0);
        const avgT = temps.length ? (sumT / temps.length) : null;
        
        // --- VÝPOČET VLHKOSTI ---
        const minH = hums.length ? hums.reduce((a, b) => b.hum < a.hum ? b : a) : null;
        const maxH = hums.length ? hums.reduce((a, b) => b.hum > a.hum ? b : a) : null;
        const sumH = hums.reduce((acc, r) => acc + r.hum, 0);
        const avgH = hums.length ? (sumH / hums.length) : null;

        // Poslední záznam
        const lastRecord = srows[srows.length - 1];

        stats[id] = {
          name: SENSOR_LABEL[id] ?? id,
          // Teplota
          minTemp: minT, maxTemp: maxT, avgTemp: avgT,
          // Vlhkost
          minHum: minH, maxHum: maxH, avgHum: avgH,
          // Aktuální
          lastTemp: lastRecord.temp, lastHum: lastRecord.hum,
          lastTime: formatTime(lastRecord.time)
        };
      });
      return stats;
    }

    // Renderování statistik do karet
    function renderStats(rows) {
      const stats = calculateStats(rows);
      const container = $("#statsContainer");
      container.innerHTML = "";
      
      const showTemp = $("#chkTemp").checked;
      const showHum = $("#chkHum").checked;
      
      // Zjistíme aktuální rozsah pro dynamické zobrazení titulku
      const range = $selRange.value;
      const isCurrentTime = range === 'today' || range === 'yesterday';
      const mainTitle = isCurrentTime ? 'Aktuální' : 'Průměr';


      for (const id in stats) {
        const s = stats[id];
        const card = document.createElement("div");
        card.classList.add("stat-card");
        
        // ÚVOD: Jméno senzoru a čas posledního záznamu
        let content = `<div class="stat-title">${s.name} (${mainTitle}: ${s.lastTime})</div><hr style="border-color:var(--muted);margin:10px 0;opacity:0.2"/>`;

        // --- Zobrazení Teploty ---
        if (showTemp && s.maxTemp) {
            // Zobrazujeme Průměr/Aktuální v závislosti na rozsahu
            const tempValue = isCurrentTime ? s.lastTemp?.toFixed(2) : s.avgTemp.toFixed(2);
            content += `
                <div class="stat-title">TEPLOTA</div>
                <div class="stat-value stat-temp">${tempValue ?? '—'} °C</div>
                <div class="stat-group">
                    <div class="stat-detail stat-min-temp">Min: ${s.minTemp.temp.toFixed(2)} °C <span style="font-size: 0.75rem">(${formatTime(s.minTemp.time)})</span></div>
                    <div class="stat-detail stat-max-temp">Max: ${s.maxTemp.temp.toFixed(2)} °C <span style="font-size: 0.75rem">(${formatTime(s.maxTemp.time)})</span></div>
                </div>
                ${!isCurrentTime ? `<div class="stat-title" style="margin-top: 5px;">Aktuální: ${s.lastTemp?.toFixed(2) ?? '—'} °C</div>` : ''}
            `;
        }

        // --- Zobrazení Vlhkosti ---
        if (showHum && s.maxHum) {
             const humValue = isCurrentTime ? s.lastHum?.toFixed(2) : s.avgHum.toFixed(2);
             content += `<hr style="border-color:var(--muted);margin:10px 0;opacity:0.2"/>`;
             content += `
                <div class="stat-title">VLHKOST</div>
                <div class="stat-value stat-hum">${humValue ?? '—'} %</div>
                <div class="stat-group">
                    <div class="stat-detail stat-min-hum">Min: ${s.minHum.hum.toFixed(2)} % <span style="font-size: 0.75rem">(${formatTime(s.minHum.time)})</span></div>
                    <div class="stat-detail stat-max-hum">Max: ${s.maxHum.hum.toFixed(2)} % <span style="font-size: 0.75rem">(${formatTime(s.maxHum.time)})</span></div>
                </div>
                ${!isCurrentTime ? `<div class="stat-title" style="margin-top: 5px;">Aktuální: ${s.lastHum?.toFixed(2) ?? '—'} %</div>` : ''}
            `;
        }
        
        card.innerHTML = content;
        container.appendChild(card);
      }
    }

    // Generování přepínačů senzorů
    function renderSensorToggles(data) {
      const allIds = [...new Set(data.map(r => r.id))];
      const container = $("#sensorToggles");
      container.innerHTML = "";

      allIds.forEach(id => {
        const toggle = document.createElement("div");
        toggle.classList.add("toggle");
        toggle.textContent = SENSOR_LABEL[id] ?? id;
        toggle.dataset.sensorId = id;
        
        // Na začátku jsou všechny aktivní, pokud nemáme uložený stav
        if (localStorage.getItem(`sensor-${id}`) !== 'false') {
             toggle.classList.add("active");
        }
        
        // Akce pro přepínání
        toggle.addEventListener("click", () => {
          toggle.classList.toggle("active");
          const isActive = toggle.classList.contains("active");
          localStorage.setItem(`sensor-${id}`, isActive);
          update(); // Aktualizace grafu po přepnutí
        });
        container.appendChild(toggle);
      });
    }

    // Filtrování dat podle přepínačů senzorů
    function filterBySensor(rows) {
      const activeSensors = [];
      $$(".toggle.active").forEach(t => {
        activeSensors.push(t.dataset.sensorId);
      });

      // Pokud není aktivní žádný senzor, zobrazíme všechny, aby se graf nezhroutil
      if (activeSensors.length === 0) return rows; 

      return rows.filter(r => activeSensors.includes(r.id));
    }


    function drawChart(datasets) {
      const isDarkMode = document.body.classList.contains("theme-dark") || document.body.classList.contains("theme-mono");
      
      // Pevná bílá pro text v tmavém režimu pro spolehlivost
      const chartTextColor = isDarkMode ? '#FFFFFF' : 'var(--chart-legend-text)'; 
      
      // Mřížka se mění s režimem
      const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : '#ddd';

      const config = {
        type: "line",
        data: { datasets: datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          color: chartTextColor,
          interaction: { mode: 'index', intersect: false }, // NOVÉ: Pro interaktivní plovoucí náhledy
          scales: {
            x: { type: "time", time: { unit: "hour" }, ticks: { color: chartTextColor }, grid: { color: gridColor } },
            yT: { position: "left", title:{display:true,text:"°C", color: chartTextColor}, ticks: { color: chartTextColor }, grid: { color: gridColor } },
            yH: { position: "right", title:{display:true,text:"%", color: chartTextColor}, ticks: { color: chartTextColor }, grid: { drawOnChartArea: false, color: gridColor }, suggestedMin: 0, suggestedMax: 100 }
          },
          plugins: {
            legend: { labels: { color: chartTextColor, font:{weight:"600"} } },
            tooltip: { // NOVÉ: Vylepšení vzhledu tooltipu
                bodyFont: { size: 12 },
                titleFont: { size: 14, weight: 'bold' },
                displayColors: true,
            },
            zoom: {
              zoom: { 
                  wheel:{enabled:true}, 
                  pinch:{enabled:true, threshold: 0.05}, 
                  mode:"x" 
              },
              pan:  { 
                  enabled:true, 
                  mode:"x",
                  threshold: 5 
              }
            }
          }
        }
      };

      if (chart) {
        chart.data.datasets = datasets;
        
        // Nastavení barvy titulku os
        chart.options.scales.yT.title.color = chartTextColor;
        chart.options.scales.yH.title.color = chartTextColor;
        
        chart.options.scales.x.ticks.color = chartTextColor;
        chart.options.scales.yT.ticks.color = chartTextColor;
        chart.options.scales.yH.ticks.color = chartTextColor;
        chart.options.plugins.legend.labels.color = chartTextColor;
        
        // Aktualizace mřížky v existujícím grafu
        chart.options.scales.x.grid.color = gridColor;
        chart.options.scales.yT.grid.color = gridColor;
        chart.options.scales.yH.grid.color = gridColor; 

        chart.update();
      } else {
        chart = new Chart($("#meteoChart"), config);
        
        // KLÍČOVÉ: ZABRÁNĚNÍ ZOOMU PROHLÍŽEČE NA DOTYKOVÝCH ZAŘÍZENÍCH
        const canvas = $("#meteoChart");
        if (canvas) {
          canvas.addEventListener('touchstart', (e) => {
              if (e.touches.length > 1) { // Pokud jsou dva nebo více prstů
                  e.preventDefault(); // Zablokuje výchozí zoom prohlížeče
              }
          }, { passive: false });
        }
      }
    }


    function update() {
      // 1. Vyfiltrovat podle časového rozsahu (celý soubor, dnes, včera, custom...)
      let rows = filterData(data);
      // 2. Vyfiltrovat podle přepínačů senzorů
      rows = filterBySensor(rows); 
      
      const showTemp = $("#chkTemp").checked;
      const showHum = $("#chkHum").checked;

      // --- Graf: Sestavení Datasets ---
      const datasets = [];
      // Zjistíme, jaké ID senzorů nám zbyly po filtrování
      const ids = [...new Set(rows.map(r => r.id))];

      
      ids.forEach(id => {
        const srows = rows.filter(r => r.id === id);
        
        // Získáme barvy pro daný ID senzoru z nové mapy, pokud existují, jinak default šedá
        const colors = SENSOR_COLORS[id] || { temp: "#cccccc", hum: "#eeeeee" };

        if (showTemp) {
          datasets.push({
            label: `${SENSOR_LABEL[id] ?? id} (°C)`,
            data: srows.map(r => ({ x: r.time, y: r.temp })),
            borderColor: colors.temp, // Používá unikátní barvu pro teplotu
            backgroundColor: "transparent",
            yAxisID: "yT",
            tension: .2,
            pointRadius: 0,
            borderWidth: 2,
            borderDash: [] // Plná čára pro teplotu
          });
        }
        if (showHum) {
          datasets.push({
            label: `${SENSOR_LABEL[id] ?? id} (%)`,
            data: srows.map(r => ({ x: r.time, y: r.hum })),
            borderColor: colors.hum, // Používá unikátní světlejší barvu pro vlhkost
            backgroundColor: "transparent",
            yAxisID: "yH",
            tension: .2,
            pointRadius: 0,
            borderWidth: 2,
            borderDash: [6, 4] // Přerušovaná čára pro vlhkost
          });
        }
      });

      drawChart(datasets);
      renderStats(rows);
    }

    // --- Akce (UPRAVENO pro vlastní rozsah) ---
    function toggleCustomRangeInputs() {
        const isCustom = $selRange.value === 'custom';
        $("#customRangeInputs").style.display = isCustom ? 'flex' : 'none';
        
        if (isCustom && !$dateFrom.value && data.length > 0) {
            const lastDate = new Date();
            const firstDate = new Date(lastDate.getTime() - 30 * 24 * 60 * 60 * 1000); // 30 dní zpět
            
            $dateFrom.value = formatDateForInput(firstDate);
            $dateTo.value = formatDateForInput(lastDate);
        }
    }

    // --- Dynamické zobrazení/skrytí menu pro Skok na čas ---
    function toggleJumpTime() {
        const isToday = $selRange.value === 'today';
        $selJumpTime.style.display = isToday ? 'block' : 'none';
        
        // Zabezpečení: Pokud se přepneme z "Dnes" na jiný rozsah, resetujeme výběr času
        if (!isToday) {
            $selJumpTime.value = "";
        }
    }

    // Obnovení uloženého tématu
    const savedTheme = localStorage.getItem('selectedTheme') || 'theme-dark';
    document.body.className = ''; 
    document.body.classList.add(savedTheme);
    $selTheme.value = savedTheme;

    $("#selFile").addEventListener("change", loadCSV);
    
    // Sloučíme akce pro selRange
    $selRange.addEventListener("change", () => {
        toggleCustomRangeInputs(); 
        toggleJumpTime(); 
        update(); 
    });

    // NOVÝ POSLUCHAČ: Rychlý skok na čas (nyní jen spouští update)
    $selJumpTime.addEventListener("change", (e) => {
        // Graf i statistiky se aktualizují, protože filterData ořízne konec dat na zvolenou hodinu
        update(); 
    });

    // Akce pro přepínání témat
    $selTheme.addEventListener("change", (e) => {
      // 1. Odeber všechny existující třídy témat
      document.body.className = ''; 
      // 2. Přidej novou třídu na <body>
      document.body.classList.add(e.target.value);
      // 3. Ulož výběr (pro zapamatování)
      localStorage.setItem('selectedTheme', e.target.value); 
      // 4. Překresli graf, aby se zohlednily barvy legendy/osy
      update(); 
    });

    $("#chkTemp").addEventListener("change", update);
    $("#chkHum").addEventListener("change", update);

    // Posluchači pro pole vlastního rozsahu
    $dateFrom.addEventListener("change", update);
    $dateTo.addEventListener("change", update);

    $("#btnReset").addEventListener("click", ()=> chart && chart.resetZoom());
    $("#btnCsv").addEventListener("click", ()=> {
      const f = $("#selFile").value;
      // preferuj /data - když neexistuje, vezmi /docs/data
      fetch(`data/${f}`,{method:"HEAD"}).then(r=>{
        location.href = r.ok ? `data/${f}` : `docs/data/${f}`;
      }).catch(()=> location.href = `data/${f}`);
    });
    $("#btnPng").addEventListener("click", ()=> {
      const a = document.createElement("a");
      a.href = chart.toBase64Image(); a.download = "graf.png"; a.click();
    });

    // start
    loadIndex().catch(err=>{
      $("#errorMessage").textContent = `Kritická chyba: ${err.message}.`;
      $("#errorMessage").style.display = "block";
    });

  </script>
</body>
</html>
