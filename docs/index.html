<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meteo archiv â€“ jednoduchÃ½ graf</title>

  <!-- JednoduÅ¡e: Chart.js bez adapterÅ¯, kateg. osa -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.js"></script>

  <style>
    :root {
      --bg:#0b1220; --panel:#0e1626; --fg:#e7eef7; --muted:#a5b3c8;
      --chip:#0f1c36; --chip-b:#2f5fa8;
    }
    :root.light {
      --bg:#f6f8fb; --panel:#ffffff; --fg:#0b1220; --muted:#5c6b82;
      --chip:#eef2f9; --chip-b:#b9c7e6;
    }
    *{box-sizing:border-box}
    body{margin:24px;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--fg)}
    .wrap{max-width:1100px;margin:0 auto}
    h1{margin:0 0 8px}
    .sub{color:var(--muted);margin-bottom:16px}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .chip{background:var(--chip);border:1px solid var(--chip-b);border-radius:10px;padding:8px 10px}
    .srcs label{margin-right:10px}
    .chart{background:var(--panel);border:1px solid var(--chip-b);border-radius:14px;padding:12px}
    canvas{width:100%;height:420px !important}
    .muted{color:var(--muted)}
    button{cursor:pointer;border:1px solid var(--chip-b);background:var(--chip);color:var(--fg);border-radius:10px;padding:8px 10px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Meteo archiv</h1>
    <div class="sub">Zdroj: <code>tmep.cz</code> Â· CSV z GitHub Pages Â· levÃ¡ osa Â°C, pravÃ¡ osa %</div>

    <div class="controls">
      <label class="chip"><input type="checkbox" id="showTemp" checked> Teplota (Â°C)</label>
      <label class="chip"><input type="checkbox" id="showHum" checked> Vlhkost (%)</label>

      <div class="chip">
        Rozsah:
        <select id="range">
          <option value="all" selected>VÅ¡e</option>
          <option value="30d">PoslednÃ­ch 30 dnÃ­</option>
          <option value="7d">PoslednÃ­ch 7 dnÃ­</option>
          <option value="today">Dnes</option>
        </select>
      </div>

      <div class="chip srcs" id="srcToggles" title="Zap/vyp stanice"></div>

      <button id="theme">ðŸŒ“ ReÅ¾im</button>
      <a id="dlCsv" class="muted" href="#" download="history.csv">StÃ¡hnout CSV</a>
    </div>

    <div class="chart">
      <canvas id="chart"></canvas>
      <div id="nodata" class="muted" style="padding:10px;display:none">Å½Ã¡dnÃ¡ data pro zvolenÃ½ filtr.</div>
    </div>
  </div>

<script>
(() => {
  // ---------- Cesta k CSV (robustnÄ›) ----------
  const repo = location.pathname.split('/').filter(Boolean)[0] || '';
  const CSV_CANDIDATES = [
    `/${repo ? repo + '/' : ''}data/history.csv`,
    'data/history.csv',
    `/${repo}/docs/data/history.csv`
  ];
  const csvLink = document.getElementById('dlCsv');

  async function loadCsv() {
    for (const u of CSV_CANDIDATES) {
      try { const r=await fetch(u,{cache:'no-store'}); if(r.ok){ csvLink.href=u; return await r.text(); } } catch(e){ /* try next */ }
    }
    throw new Error('CSV history.csv nebylo nalezeno ve /docs/data/.');
  }

  // ---------- PomocnÃ© ----------
  function unique(arr){ return Array.from(new Set(arr)); }
  function by(a, b) { return a < b ? -1 : a > b ? 1 : 0; }

  function parseCsv(text){
    const lines = text.replace(/\uFEFF/g,'').split(/\r?\n/).filter(l=>l.trim().length>0);
    const headerIdx = lines.findIndex(l => /^timestamp_iso,/.test(l.trim()));
    const header = (headerIdx>=0?lines[headerIdx]:lines[0]).split(',');
    const idxTs = header.indexOf('timestamp_iso');
    let   idxS  = header.indexOf('source'); // mÅ¯Å¾e bÃ½t -1 (starÃ½ formÃ¡t)
    const idxT  = header.indexOf('temp_c');
    const idxH  = header.indexOf('humidity_pct');
    const rows  = (headerIdx>=0?lines.slice(headerIdx+1):lines.slice(1));

    const out=[];
    for(const l of rows){
      if(/^timestamp_iso,/.test(l)) continue;
      const p=l.split(',');
      if (p.length < (idxS>=0?4:3)) continue;
      const ts = new Date(p[idxTs]);
      if (Number.isNaN(ts.getTime())) continue;
      const src = idxS>=0 ? (p[idxS]||'').trim() : 'default';
      const tStr=(p[idxT]||'').replace(',','.').trim();
      const hStr=(p[idxH]||'').replace(',','.').trim();
      const temp=tStr===''?null:Number(tStr);
      const hum =hStr===''?null:Number(hStr);
      if ((temp===null||Number.isNaN(temp)) && (hum===null||Number.isNaN(hum))) continue;
      out.push({ ts, src:String(src), temp:Number.isNaN(temp)?null:temp, hum:Number.isNaN(hum)?null:hum });
    }
    return out.sort((a,b)=>a.ts-b.ts);
  }

  function buildLabels(rows){
    // spoleÄnÃ¡ mnoÅ¾ina Å¡tÃ­tkÅ¯ napÅ™Ã­Ä zdroji
    const map=new Map();
    rows.forEach(r=>{
      const label=r.ts.toLocaleString('cs-CZ',{hour12:false});
      if(!map.has(label)) map.set(label,r.ts);
    });
    return Array.from(map.keys()).sort((a,b)=> by(map.get(a), map.get(b)));
  }

  function rangeFilter(rows, mode){
    const now=new Date();
    let from=new Date(0), to=new Date(8640000000000000);
    if (mode==='today'){ const d0=new Date(now); d0.setHours(0,0,0,0); const d1=new Date(now); d1.setHours(23,59,59,999); from=d0; to=d1; }
    else if (mode==='7d')  from=new Date(now.getTime()-7*24*3600*1000);
    else if (mode==='30d') from=new Date(now.getTime()-30*24*3600*1000);
    return rows.filter(r => r.ts>=from && r.ts<=to).sort((a,b)=>a.ts-b.ts);
  }

  function makeDatasets(labels, rows, enabledSources, showTemp, showHum){
    const datasets=[];
    const srcs = enabledSources;
    for(const src of srcs){
      const arr = rows.filter(r=>r.src===src);
      if (showTemp){
        const mapT=new Map(arr.map(r=>[ r.ts.toLocaleString('cs-CZ',{hour12:false}), r.temp ]));
        const dataT = labels.map(L => mapT.has(L)? mapT.get(L): null);
        datasets.push({ label:`Teplota (Â°C) â€“ ${src}`, data:dataT, yAxisID:'yT', tension:0.25, spanGaps:true, pointRadius:0 });
      }
      if (showHum){
        const mapH=new Map(arr.map(r=>[ r.ts.toLocaleString('cs-CZ',{hour12:false}), r.hum ]));
        const dataH = labels.map(L => mapH.has(L)? mapH.get(L): null);
        datasets.push({ label:`Vlhkost (%) â€“ ${src}`, data:dataH, yAxisID:'yH', tension:0.25, spanGaps:true, pointRadius:0 });
      }
    }
    return datasets;
  }

  // ---------- App ----------
  const showTempEl = document.getElementById('showTemp');
  const showHumEl  = document.getElementById('showHum');
  const rangeEl    = document.getElementById('range');
  const togglesEl  = document.getElementById('srcToggles');
  const themeBtn   = document.getElementById('theme');
  const ctx        = document.getElementById('chart').getContext('2d');
  const noDataEl   = document.getElementById('nodata');
  let chart, RAW=[], sources=[], enabledSrc={};

  // tÃ©ma pÅ™epÃ­naÄ
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme==='light') document.documentElement.classList.add('light');
  themeBtn.addEventListener('click', () => {
    document.documentElement.classList.toggle('light');
    localStorage.setItem('theme', document.documentElement.classList.contains('light')?'light':'dark');
  });

  // naÄÃ­st CSV a spustit
  loadCsv()
    .then(text => {
      RAW = parseCsv(text);
      sources = unique(RAW.map(r=>r.src)).sort();
      // vytvoÅ™ checkboxy pro zdroje
      togglesEl.innerHTML = '';
      sources.forEach(src => {
        enabledSrc[src]=true;
        const id='src_'+src.replace(/\W/g,'_');
        const lbl=document.createElement('label'); lbl.className='chip';
        lbl.innerHTML = `<input type="checkbox" id="${id}" data-src="${src}" checked> Stanice ${src}`;
        lbl.addEventListener('change', e => { enabledSrc[src] = e.target.checked; redraw(); });
        togglesEl.appendChild(lbl);
      });
      redraw();
    })
    .catch(err => {
      console.error(err);
      alert('NepodaÅ™ilo se naÄÃ­st data (CSV). Ujisti se, Å¾e je v /docs/data/history.csv.');
    });

  // pÅ™epÃ­naÄe
  [showTempEl, showHumEl, rangeEl].forEach(el => el.addEventListener('change', redraw));

  function redraw(){
    const enabled = sources.filter(s => enabledSrc[s]);
    const filtered = rangeFilter(RAW, rangeEl.value).filter(r => enabled.includes(r.src));
    const labels   = buildLabels(filtered);
    const datasets = makeDatasets(labels, filtered, enabled, showTempEl.checked, showHumEl.checked);

    // kdyÅ¾ nenÃ­ co vykreslit
    const hasData = datasets.some(ds => ds.data.some(v => v !== null));
    if (!labels.length || !hasData){
      if (chart){ chart.destroy(); chart=null; }
      noDataEl.style.display='block';
      return;
    } else {
      noDataEl.style.display='none';
    }

    // dynamickÃ½ rozsah teploty
    const tVals = datasets.filter(d=>d.yAxisID==='yT').flatMap(d=>d.data).filter(v=>v!==null&&!Number.isNaN(v));
    const tMin  = tVals.length? Math.min(...tVals) : undefined;
    const tMax  = tVals.length? Math.max(...tVals) : undefined;
    const yTopt = (tMin!==undefined && tMax!==undefined) ? {
      suggestedMin: tMin - Math.abs(tMax - tMin)*0.1,
      suggestedMax: tMax + Math.abs(tMax - tMin)*0.1
    } : {};

    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type:'line',
      data:{ labels, datasets },
      options:{
        responsive:true, maintainAspectRatio:false, animation:false,
        interaction:{ mode:'index', intersect:false },
        scales:{
          x:{ ticks:{ autoSkip:true, maxRotation:0 } },
          yT:{ title:{display:true, text:'Â°C'}, grid:{drawBorder:false}, ...yTopt },
          yH:{ position:'right', title:{display:true, text:'%'}, grid:{drawOnChartArea:false}, suggestedMin:0, suggestedMax:100 }
        },
        plugins:{ legend:{ position:'top' } }
      }
    });
  }
})();
</script>
</body>
</html>
