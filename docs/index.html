<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Meteo archiv</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js"></script>
  <style>
    /* PÅ¯vodnÃ­ TÃ©ma: Oceanic Dark (VÃ½chozÃ­) */
    :root, .theme-dark {
      --bg: #0f1115;
      --card: #171a21;
      --muted: #9aa4b2;
      --text: #e7edf4;
      --accent: #2dd4bf;
      --danger: #f43f5e;
      --info: #60a5fa;
      --chart-bg: #fff; /* Barva pozadÃ­ grafu */
      --chart-legend-text: #111; /* Barva textu legendy */
    }

    /* TÃ©ma 2: KÅ™iÅ¡Å¥Ã¡lovÄ› bÃ­lÃ© (Crystal Light) */
    .theme-light {
      --bg: #f8f8f8;
      --card: #ffffff;
      --muted: #6b7280;
      --text: #1f2937;
      --accent: #2563eb;
      --danger: #ef4444;
      --info: #06b6d4;
      --chart-bg: #ffffff;
      --chart-legend-text: #111;
    }
    
    /* TÃ©ma 3: NoÄnÃ­ (Midnight Blue) */
    .theme-midnight {
      --bg: #050b18;
      --card: #101931;
      --muted: #7d8ea2;
      --text: #c3d2e6;
      --accent: #a3a0e5;
      --danger: #cc6666;
      --info: #85c2c7;
      --chart-bg: #101931; /* TmavÃ© pozadÃ­ pro graf */
      --chart-legend-text: #c3d2e6; /* SvÄ›tlÃ½ text pro legendu */
    }

    /* TÃ©ma 4: EnergetickÃ© (Vibrant Neon) */
    .theme-neon {
      --bg: #111111;
      --card: #202020;
      --muted: #888888;
      --text: #f0f0f0;
      --accent: #00ff99; /* NeonovÄ› zelenÃ¡ */
      --danger: #ff33cc; /* NeonovÄ› rÅ¯Å¾ovÃ¡ */
      --info: #33ccff; /* NeonovÄ› modrÃ¡ */
      --chart-bg: #111111;
      --chart-legend-text: #f0f0f0;
    }

    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial; transition: background .3s;}
    header{display:flex;align-items:center;gap:.6rem;padding:14px 18px;border-bottom:1px solid var(--card);} 
    header .logo{width:22px;height:22px;background:radial-gradient(circle at 30% 30%,#ffd166,#ff9900);border-radius:50%;}
    header h1{font-size:1.05rem;margin:0;font-weight:700}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    .controls{display:flex;flex-wrap:wrap;gap:.6rem;align-items:center;margin-bottom:.8rem}
    .controls .group{display:flex;gap:.6rem;align-items:center;background:var(--card);padding:8px 10px;border-radius:10px}
    label{display:inline-flex;gap:.35rem;align-items:center;cursor:pointer;font-size:.95rem}
    input[type="checkbox"]{width:18px;height:18px;accent-color:var(--accent)}
    select,button,input[type="datetime-local"]{background:var(--bg);color:var(--text);border:1px solid var(--muted);border-radius:10px;padding:8px 10px;font-size:.95rem; transition: background .3s;} 
    button.icon{display:inline-flex;gap:.4rem;align-items:center}
    button#btnCsv{background:#0b3b73;border-color:#0b3b73}
    button#btnPng{background:#0b5d48;border-color:#0b5d48}
    button#btnReset{background:#5a3b09;border-color:#5a3b09}
    .stats{display:flex;gap:.8rem;flex-wrap:wrap;margin:.6rem 0}
    .stat{flex:1 1 200px;background:var(--card);border-radius:12px;padding:12px 14px}
    .stat .ttl{font-size:.9rem;color:var(--muted);margin-bottom:.25rem}
    .stat .val{font-size:1.6rem;font-weight:800}
    .stat .sub{margin-top:.15rem;color:var(--muted);font-size:.88rem}
    .chart-card{background:var(--chart-bg);border-radius:12px;padding:10px; transition: background .3s;} 
    canvas{display:block;width:100%;height:420px;max-height:70vh}
    .bad{color:var(--danger)} 
    #rangeBadge{font-size:.85rem;color:var(--muted)}
    .sensorPills{display:flex;flex-wrap:wrap;gap:.5rem}
    .pill{background:var(--bg);border:1px solid var(--muted);color:var(--text);padding:4px 10px;border-radius:999px;font-size:.85rem; transition: background .3s;} 
    
    /* RESPONZIVNÃ ÃšPRAVY PRO MOBILY */
    @media (max-width:700px){
      .controls .group{width:100%;justify-content:space-between; flex-wrap: wrap;} 
      .controls .group:nth-child(2) > * {
          flex-grow: 1; 
          min-width: 120px; 
      }
      .stat{flex:1 1 calc(50% - 0.5rem);} 
      #customRangeGroup{flex-wrap:wrap}
      #customRangeGroup input{flex:1 1 45%;min-width:140px} 
      canvas{height:360px}
    }
  </style>
</head>
<body>
  <header>
    <div class="logo"></div>
    <h1>Meteo archiv</h1>
  </header>

  <div class="wrap">
    <div class="controls">
      <div class="group">
        <label><input id="chkTemp" type="checkbox" checked> Teplota (Â°C)</label>
        <label><input id="chkHum" type="checkbox" checked> Vlhkost (%)</label>
      </div>

      <div class="group">
        <select id="selRange">
          <option value="today" selected>DneÅ¡ek</option>
          <option value="week">TÃ½den</option>
          <option value="month">MÄ›sÃ­c</option>
          <option value="all">VÅ¡e</option>
          <option value="custom">VlastnÃ­</option>
        </select>
        
        <select id="selTheme">
          <option value="theme-dark" selected>Oceanic Dark</option>
          <option value="theme-light">KÅ™iÅ¡Å¥Ã¡lovÄ› bÃ­lÃ©</option>
          <option value="theme-midnight">NoÄnÃ­ (TmavÃ©)</option>
          <option value="theme-neon">EnergetickÃ©</option>
        </select>

        <div id="customRangeGroup" style="display:none; gap:.6rem;">
          <input type="datetime-local" id="dateFrom" title="Datum a Äas Od">
          <input type="datetime-local" id="dateTo" title="Datum a Äas Do">
        </div>

        <select id="selFile"></select>

        <button id="btnReset" class="icon" title="Reset zoom"><span>â†º</span> Reset</button>
        <button id="btnCsv" class="icon" title="StÃ¡hnout CSV">ğŸ“„ CSV</button>
        <button id="btnPng" class="icon" title="StÃ¡hnout PNG graf">ğŸ–¼ PNG</button>
      </div>
    </div>

    <div class="controls">
      <div id="sensorBox" class="sensorPills"></div>
      <span id="rangeBadge"></span>
    </div>

    <div class="stats">
      <div class="stat">
        <div class="ttl">Min. teplota ğŸ¥¶</div>
        <div class="val" id="minTVal">â€“</div>
        <div class="sub" id="minTInfo">â€“</div>
      </div>
      <div class="stat">
        <div class="ttl">Max. teplota ğŸ”¥</div>
        <div class="val" id="maxTVal">â€“</div>
        <div class="sub" id="maxTInfo">â€“</div>
      </div>
      <div class="stat">
        <div class="ttl">PrÅ¯mÄ›rnÃ¡ teplota ğŸŒ¡ï¸</div>
        <div class="val" id="avgTVal">â€“</div>
        <div class="sub" id="rangeTInfo">â€“</div> </div>
      
      <div class="stat">
        <div class="ttl">Min. vlhkost ğŸ’§</div>
        <div class="val" id="minHVal">â€“</div>
        <div class="sub" id="minHInfo">â€“</div>
      </div>
      <div class="stat">
        <div class="ttl">Max. vlhkost ğŸ’¦</div>
        <div class="val" id="maxHVal">â€“</div>
        <div class="sub" id="maxHInfo">â€“</div>
      </div>
      <div class="stat">
        <div class="ttl">PrÅ¯mÄ›rnÃ¡ vlhkost ğŸ’¨</div>
        <div class="val" id="avgHVal">â€“</div>
        <div class="sub" id="rangeHInfo">â€“</div> </div>
    </div>

    <div class="chart-card"><canvas id="chart"></canvas></div>
  </div>

  <script>
    // --- PomocnÃ© ---
    const SENSOR_LABEL = { "4065": "UNI", "2764": "Venek" };

    const $ = sel => document.querySelector(sel);
    const fmt = d => new Date(d).toLocaleString();

    // Konstanty pro ovlÃ¡dÃ¡nÃ­
    const $selRange = $("#selRange");
    const $customGroup = $("#customRangeGroup");
    const $dateFrom = $("#dateFrom");
    const $dateTo = $("#dateTo");
    const $selTheme = $("#selTheme");

    // NOVÃ‰: Logika pro naÄtenÃ­ uloÅ¾enÃ©ho tÃ©matu pÅ™i startu
    const savedTheme = localStorage.getItem('selectedTheme') || 'theme-dark';
    document.body.classList.add(savedTheme);
    // Nastav sprÃ¡vnou hodnotu v selectu pÅ™i startu
    if ($selTheme) $selTheme.value = savedTheme;

    async function fetchJSON(paths) {
      for (const p of paths) {
        try {
          const r = await fetch(p, { cache: "no-store" });
          if (r.ok) return await r.json();
        } catch {}
      }
      throw new Error("index.json nenalezen (zkouÅ¡eno: " + paths.join(", ") + ")");
    }
    async function fetchText(paths) {
      for (const p of paths) {
        try {
          const r = await fetch(p, { cache: "no-store" });
          if (r.ok) return await r.text();
        } catch {}
      }
      throw new Error("CSV nenalezeno (zkouÅ¡eno: " + paths.join(", ") + ")");
    }

    // --- Stav ---
    let allRows = [];      // pÅ¯vodnÃ­ data (vÅ¡e)
    let visibleSensors = new Set(); // viditelnÃ© senzory
    let chart;

    // --- NaÄtenÃ­ seznamu souborÅ¯ ---
    async function loadIndex() {
      const files = await fetchJSON(["data/index.json","docs/data/index.json"]);
      const sel = $("#selFile");
      sel.innerHTML = "";
      files.forEach(f => {
        const o = document.createElement("option");
        o.value = f; o.textContent = f;
        sel.appendChild(o);
      });
      // preferuj history.csv, kdyÅ¾ existuje
      if (files.includes("history.csv")) sel.value = "history.csv";
      await loadCSV();
    }

    // --- NaÄtenÃ­ CSV ---
    async function loadCSV() {
      const f = $("#selFile").value;
      const text = await fetchText([`data/${f}`,`docs/data/${f}`]);

      const lines = text.trim().split(/\r?\n/);
      // Podpora s/bez hlaviÄky
      let start = 0;
      if (lines[0].toLowerCase().includes("timestamp")) start = 1;

      allRows = [];
      for (let i = start; i < lines.length; i++) {
        const [ts, id, t, h] = lines[i].split(",");
        if (!ts || !id) continue;
        const time = new Date(ts);
        const temp = parseFloat(t);
        const hum  = parseFloat(h);
        if (Number.isNaN(time.getTime())) continue;
        allRows.push({ time, id, temp, hum });
      }

      // Inicializuj viditelnÃ© senzory
      const ids = [...new Set(allRows.map(r => r.id))].sort();
      visibleSensors = new Set(ids);
      renderSensorToggles(ids);

      toggleCustomRangeInputs();
      update();
    }

    // --- PÅ™epÃ­naÄe senzorÅ¯ (pills) ---
    function renderSensorToggles(ids){
      const box = $("#sensorBox");
      box.innerHTML = "";
      ids.forEach(id => {
        const pill = document.createElement("label");
        pill.className = "pill";
        pill.innerHTML = `<input type="checkbox" data-id="${id}" checked style="accent-color:#2dd4bf;margin-right:6px"> ${SENSOR_LABEL[id] ?? id}`;
        pill.querySelector("input").addEventListener("change", (e)=>{
          if (e.target.checked) visibleSensors.add(id);
          else visibleSensors.delete(id);
          update();
        });
        box.appendChild(pill);
      });
    }
    
    // ZobrazenÃ­/skrytÃ­ polÃ­ pro vlastnÃ­ rozsah a nastavenÃ­ vÃ½chozÃ­ch hodnot
    function toggleCustomRangeInputs(){
      if ($selRange.value === "custom") {
        $customGroup.style.display = "flex"; // Zobrazit
        // NastavÃ­me vÃ½chozÃ­ hodnoty (dneÅ¡ek) pokud nejsou nastavenÃ©
        if (!$dateFrom.value || !$dateTo.value) {
            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            // FormÃ¡t pro input[type="datetime-local"] je YYYY-MM-DDTHH:mm
            const toStr = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            const fromStr = new Date(startOfDay.getTime() - (startOfDay.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            $dateFrom.value = fromStr;
            $dateTo.value = toStr;
        }
      } else {
        $customGroup.style.display = "none"; // SkrÃ½t
      }
    }


    // --- FiltrovÃ¡nÃ­ dle rozsahu ---
    function filterByRange(rows){
      const range = $selRange.value;
      const badge = $("#rangeBadge");
      
      let from = null;
      let to = new Date(); 

      // 1. Logika pro rychlÃ© volby
      if (range !== "custom" && range !== "all") {
        const now = new Date();
        if (range === "today") from = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        else if (range === "week") from = new Date(now.getTime() - 7*24*3600*1000);
        else if (range === "month") from = new Date(now.getTime() - 31*24*3600*1000);
        
      } 
      // 2. Logika pro vlastnÃ­ rozsah ("custom")
      else if (range === "custom") {
        from = $dateFrom.value ? new Date($dateFrom.value) : null;
        to = $dateTo.value ? new Date($dateTo.value) : new Date();
        
        // Kontrola platnosti dat pro custom rozsah
        if (!from || Number.isNaN(from.getTime()) || Number.isNaN(to.getTime())) {
          badge.textContent = "Zobrazeno: NeplatnÃ½ vlastnÃ­ rozsah";
          return [];
        }
      }

      // Filtr
      const filteredRows = rows.filter(r => {
        const afterFrom = from ? r.time.getTime() >= from.getTime() : true;
        const beforeTo = r.time.getTime() <= to.getTime();
        return afterFrom && beforeTo;
      });
      
      // Aktualizace badge
      const toStr = to.toLocaleString();
      const fromStr = from ? from.toLocaleString() : "â€”";
      badge.textContent = `Zobrazeno: ${fromStr} â€” ${toStr}`;
      
      return filteredRows;
    }

    // --- PÅ™epoÄet statistik + render grafu ---
    function update(){
      const showTemp = $("#chkTemp").checked;
      const showHum  = $("#chkHum").checked;

      // filtrace
      const rows = filterByRange(allRows).filter(r => visibleSensors.has(r.id));
      
      // --- VÃPOÄŒET STATISTIK PRO TEPLOTU ---
      const tRows = rows.filter(r => Number.isFinite(r.temp));
      if (tRows.length) {
        const minT = tRows.reduce((a,b)=> b.temp < a.temp ? b : a);
        const maxT = tRows.reduce((a,b)=> b.temp > a.temp ? b : a);
        const sumT = tRows.reduce((acc, r) => acc + r.temp, 0);
        const avgT = sumT / tRows.length;
        const rangeT = maxT.temp - minT.temp;

        $("#minTVal").textContent = `${minT.temp.toFixed(2)} Â°C`;
        $("#maxTVal").textContent = `${maxT.temp.toFixed(2)} Â°C`;
        $("#avgTVal").textContent = `${avgT.toFixed(2)} Â°C`;
        
        $("#minTInfo").textContent = `${SENSOR_LABEL[minT.id] ?? minT.id}, ${fmt(minT.time)}`;
        $("#maxTInfo").textContent = `${SENSOR_LABEL[maxT.id] ?? maxT.id}, ${fmt(maxT.time)}`;
        $("#rangeTInfo").textContent = `Rozsah: ${rangeT.toFixed(2)} Â°C`;
      } else {
        $("#minTVal").textContent = "â€“"; $("#maxTVal").textContent = "â€“"; $("#avgTVal").textContent = "â€“";
        $("#minTInfo").textContent = "â€“"; $("#maxTInfo").textContent = "â€“"; $("#rangeTInfo").textContent = "â€“";
      }
      
      // --- VÃPOÄŒET STATISTIK PRO VLHKOST ---
      const hRows = rows.filter(r => Number.isFinite(r.hum));
      if (hRows.length) {
        const minH = hRows.reduce((a,b)=> b.hum < a.hum ? b : a);
        const maxH = hRows.reduce((a,b)=> b.hum > a.hum ? b : a);
        const sumH = hRows.reduce((acc, r) => acc + r.hum, 0);
        const avgH = sumH / hRows.length;
        const rangeH = maxH.hum - minH.hum;

        $("#minHVal").textContent = `${minH.hum.toFixed(2)} %`;
        $("#maxHVal").textContent = `${maxH.hum.toFixed(2)} %`;
        $("#avgHVal").textContent = `${avgH.toFixed(2)} %`;
        
        $("#minHInfo").textContent = `${SENSOR_LABEL[minH.id] ?? minH.id}, ${fmt(minH.time)}`;
        $("#maxHInfo").textContent = `${SENSOR_LABEL[maxH.id] ?? maxH.id}, ${fmt(maxH.time)}`;
        $("#rangeHInfo").textContent = `Rozsah: ${rangeH.toFixed(2)} %`;
      } else {
        $("#minHVal").textContent = "â€“"; $("#maxHVal").textContent = "â€“"; $("#avgHVal").textContent = "â€“";
        $("#minHInfo").textContent = "â€“"; $("#maxHInfo").textContent = "â€“"; $("#rangeHInfo").textContent = "â€“";
      }

      // ------------------------------------
      // --- dataset a drawChart ---
      // ------------------------------------
      
      // dataset
      const ids = [...new Set(rows.map(r=>r.id))].sort();
      const datasets = [];
      const colorFor = id => id === "4065" ? "#ef4444" : "#3b82f6"; // UNI=ÄervenÃ¡, Venek=modrÃ¡

      ids.forEach(id=>{
        const srows = rows.filter(r=>r.id===id);
        if (showTemp) {
          datasets.push({
            label: `${SENSOR_LABEL[id] ?? id} (Â°C)`,
            data: srows.map(r=>({x:r.time,y:r.temp})),
            borderColor: colorFor(id),
            backgroundColor: "transparent",
            yAxisID: "yT",
            tension: .2,
            pointRadius: 0,
            borderWidth: 2
          });
        }
        if (showHum) {
          datasets.push({
            label: `${SENSOR_LABEL[id] ?? id} (%)`,
            data: srows.map(r=>({x:r.time,y:r.hum})),
            borderColor: id === "4065" ? "#f97316" : "#22d3ee",
            backgroundColor: "transparent",
            yAxisID: "yH",
            tension: .2,
            pointRadius: 0,
            borderDash: [6,4],
            borderWidth: 2
          });
        }
      });

      drawChart(datasets);
    }

    function drawChart(datasets){
      const ctx = $("#chart").getContext("2d");
      if (chart) chart.destroy();

      const isMobile = window.innerWidth <= 700;
      const ticksLimit = isMobile ? 5 : 7;
      const legendFontSize = isMobile ? 10 : 12;
      const titleFontSize = isMobile ? 10 : 12;
      
      // ZÃ­skej barvu pro text legendy/osy z aktivnÃ­ho CSS tÃ©matu
      const chartLegendTextColor = getComputedStyle(document.body).getPropertyValue('--chart-legend-text').trim() || '#111';

      chart = new Chart(ctx, {
        type: "line",
        data: { datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          interaction: { mode: "nearest", axis: "x", intersect: false },
          layout: {
            padding: { top: 10, bottom: isMobile ? 0 : 10 }
          },
          scales: {
            x: {
              type: "time",
              time: { tooltipFormat: "dd.MM.yyyy HH:mm", displayFormats: { hour: "HH:mm", day: "d.M." } },
              ticks: { 
                autoSkip: true, 
                maxTicksLimit: ticksLimit,
                color: chartLegendTextColor,
                font: { size: titleFontSize }
              },
              grid: { color: "#eee2", drawBorder:false }
            },
            yT: { 
              position: "left", 
              title:{display:true,text:"Â°C", font: { size: titleFontSize }}, 
              grid:{color:"#eee2"}, 
              suggestedMin: null, suggestedMax: null,
              ticks: { color: chartLegendTextColor, font: { size: titleFontSize } }
            },
            yH: { 
              position: "right", 
              title:{display:true,text:"%", font: { size: titleFontSize }}, 
              grid:{drawOnChartArea:false}, 
              suggestedMin: 0, suggestedMax: 100,
              ticks: { color: chartLegendTextColor, font: { size: titleFontSize } }
            }
          },
          plugins: {
            legend: { 
              labels: { 
                color: chartLegendTextColor,
                font:{ weight:"600", size: legendFontSize },
                boxWidth: isMobile ? 10 : 40,
                padding: 10
              } 
            },
            tooltip: {
                titleFont: { size: 12 },
                bodyFont: { size: 11 },
            },
            zoom: {
              zoom: { wheel:{enabled:true}, pinch:{enabled:true, threshold: 0.1}, mode:"x" },
              pan:  { enabled:true, mode:"x", threshold: 5 }
            }
          }
        }
      });
    }

    // --- Akce ---
    $("#selFile").addEventListener("change", loadCSV);
    
    // SlouÄÃ­me akce pro selRange
    $selRange.addEventListener("change", ()=>{
        toggleCustomRangeInputs(); // PÅ™epne zobrazenÃ­ polÃ­
        update(); // Aktualizuje graf
    });
    
    // Akce pro pÅ™epÃ­nÃ¡nÃ­ tÃ©mat
    $selTheme.addEventListener("change", (e) => {
      // 1. Odeber vÅ¡echny existujÃ­cÃ­ tÅ™Ã­dy tÃ©mat
      document.body.className = ''; 
      // 2. PÅ™idej novou tÅ™Ã­du na <body>
      document.body.classList.add(e.target.value);
      // 3. UloÅ¾ vÃ½bÄ›r (pro zapamatovÃ¡nÃ­)
      localStorage.setItem('selectedTheme', e.target.value); 
      // 4. PÅ™ekresli graf, aby se zohlednily barvy legendy/osy
      update(); 
    });

    $("#chkTemp").addEventListener("change", update);
    $("#chkHum").addEventListener("change", update);

    // PosluchaÄi pro pole vlastnÃ­ho rozsahu
    $dateFrom.addEventListener("change", update);
    $dateTo.addEventListener("change", update);

    $("#btnReset").addEventListener("click", ()=> chart && chart.resetZoom());
    $("#btnCsv").addEventListener("click", ()=> {
      const f = $("#selFile").value;
      // preferuj /data - kdyÅ¾ neexistuje, vezmi /docs/data
      fetch(`data/${f}`,{method:"HEAD"}).then(r=>{
        location.href = r.ok ? `data/${f}` : `docs/data/${f}`;
      }).catch(()=> location.href = `data/${f}`);
    });
    $("#btnPng").addEventListener("click", ()=>{
      const a = document.createElement("a");
      a.href = chart.toBase64Image(); a.download = "graf.png"; a.click();
    });

    // start
    loadIndex().catch(err=>{
      console.error(err);
      alert("NepodaÅ™ilo se naÄÃ­st data (index.json). Zkontroluj, Å¾e existuje v `docs/data/`.");
    });
  </script>
</body>
</html>
