<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meteo archiv ‚Äì teplota & vlhkost</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    :root {
      /* Tmav√Ω motiv (v√Ωchoz√≠) */
      --bg:#0b1220; --card:#0e1626; --fg:#e7eef7; --muted:#a5b3c8;
      --accent:#78c6ff;
      --chip-bg:#0f1c36; --chip-border:#2f5fa8; --chip-hover:#173b6a; --chip-active:#1f4c8f;
      --ok:#64d97a; --warn:#ffb86b; --err:#ff6b8b;
    }
    /* Svƒõtl√Ω motiv */
    :root.light {
      --bg:#f6f8fb; --card:#ffffff; --fg:#0b1220; --muted:#5c6b82;
      --accent:#2b6bff;
      --chip-bg:#eef2f9; --chip-border:#b9c7e6; --chip-hover:#dfe9ff; --chip-active:#c9dbff;
      --ok:#128a3a; --warn:#c06600; --err:#c21f3a;
    }

    * { box-sizing: border-box; }
    body { margin:24px; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--fg); }
    .wrap { max-width:1100px; margin:0 auto; }
    h1 { margin:0 0 6px; font-size:1.8rem; }
    .sub { color:var(--muted); margin-bottom:18px; }

    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:12px 0 12px; }
    .controls > * { background:var(--chip-bg); border:1px solid var(--chip-border); padding:8px 10px; border-radius:12px; }
    label { display:flex; align-items:center; gap:8px; }
    input[type="checkbox"] { accent-color: var(--accent); }
    button { cursor:pointer; color:var(--fg); background:var(--chip-bg); border:1px solid var(--chip-border); border-radius:12px; }
    button:hover { background:var(--chip-hover); border-color:#3a79d9; }
    button:active { background:var(--chip-active); border-color:#4894ff; }

    /* PILULKY */
    .pill-group { display:flex; gap:8px; }
    .pill {
      background: var(--chip-bg); border: 1px solid var(--chip-border); color: var(--fg);
      padding: 8px 14px; border-radius: 9999px; cursor: pointer; user-select: none;
    }
    .pill:hover { background: var(--chip-hover); border-color:#3a79d9; }
    .pill[aria-pressed="true"] { background: var(--chip-active); border-color:#4894ff; }

    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input[type="date"] { color:var(--fg); background:transparent; border:none; outline:none; }

    /* Select-like ƒçip */
    .chip-select { display:flex; gap:6px; align-items:center; }
    .chip-select select { background:transparent; border:none; color:var(--fg); outline:none; }

    /* Statistiky */
    .stats { margin-top:12px; background:var(--card); border:1px solid var(--chip-border); border-radius:14px; padding:12px; }
    .stats-grid { display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:8px; }
    .stat { padding:8px; background:var(--chip-bg); border:1px solid var(--chip-border); border-radius:10px; }
    .stat .label { color:var(--muted); font-size:.85rem; }
    .stat .val { font-weight:600; }

    canvas {
      background: var(--card); border-radius:16px; padding:12px;
      width:100%; height:420px !important; /* fix v√Ω≈°ky grafu */
      margin-top:10px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Meteo archiv</h1>
    <div class="sub">Zdroj: <code>tmep.cz</code> (periodick√Ω sbƒõr GitHub Actions) ¬∑ zobrazen√≠ lok√°ln√≠ho ƒçasu</div>

    <div class="controls">
      <label><input type="checkbox" id="showTemp" checked> Teplota (¬∞C)</label>
      <label><input type="checkbox" id="showHum"  checked> Vlhkost (%)</label>

      <div class="pill-group" id="rangePills">
        <button class="pill" data-range="today" aria-pressed="true">Dnes</button>
        <button class="pill" data-range="7d">7 dn√≠</button>
        <button class="pill" data-range="30d">30 dn√≠</button>
        <button class="pill" data-range="all">V≈°e</button>
        <button class="pill" id="toggleCustom" type="button">Vlastn√≠‚Ä¶</button>
      </div>

      <div class="row" id="customRange" style="display:none">
        <label>Od: <input type="date" id="fromDate"></label>
        <label>Do: <input type="date" id="toDate"></label>
        <button id="applyRange" type="button">Pou≈æ√≠t</button>
      </div>

      <div class="chip-select">
        <span>Agregace:</span>
        <select id="agg">
          <option value="raw">≈Ω√°dn√°</option>
          <option value="hour">Po hodin√°ch</option>
        </select>
      </div>

      <label><input type="checkbox" id="smooth"> Hlad≈°√≠ (MA-5)</label>

      <button id="theme" type="button" title="P≈ôepnout svƒõtl√Ω/tmav√Ω re≈æim">üåì Re≈æim</button>
      <button id="dlPng" type="button">St√°hnout PNG</button>
      <a id="dlCsv" href="#" download="history.csv"><button type="button">St√°hnout CSV</button></a>
    </div>

    <div class="stats" id="stats">
      <div class="stats-grid">
        <div class="stat"><div class="label">Body</div><div class="val" id="s-count">‚Äì</div></div>
        <div class="stat"><div class="label">Teplota min / max / pr≈Ømƒõr (¬∞C)</div><div class="val" id="s-t">‚Äì</div></div>
        <div class="stat"><div class="label">Vlhkost min / max / pr≈Ømƒõr (%)</div><div class="val" id="s-h">‚Äì</div></div>
        <div class="stat"><div class="label">V√Ωpadky (>= 2√ó bƒõ≈æn√Ω interval)</div><div class="val" id="s-gaps">‚Äì</div></div>
      </div>
    </div>

    <canvas id="chart"></canvas>
  </div>

<script>
(async () => {
  // --------- Pomocn√© -----------
  const base = location.pathname.split('/').filter(Boolean)[0] || '';
  const CSV_URL = `/${base ? base + '/' : ''}data/history.csv`;
  document.getElementById('dlCsv').href = CSV_URL;

  const fmt = (n, d=2) => (n===null || n===undefined || Number.isNaN(n)) ? '‚Äì' : Number(n).toFixed(d);
  const avg = arr => arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : NaN;
  const median = arr => {
    if (!arr.length) return NaN;
    const s = arr.slice().sort((a,b)=>a-b); const m = Math.floor(s.length/2);
    return s.length%2 ? s[m] : (s[m-1]+s[m])/2;
  };

  function movingAverage(data, win=5) {
    const out = Array(data.length).fill(null);
    let q = [];
    for (let i=0;i<data.length;i++) {
      const v = data[i];
      if (v!==null && !Number.isNaN(v)) q.push(v);
      if (q.length>win) q.shift();
      out[i] = q.length ? q.reduce((a,b)=>a+b,0)/q.length : null;
    }
    return out;
  }

  function aggregateHourly(rows) {
    const map = new Map(); // key: YYYY-MM-DD HH (lok√°lnƒõ)
    for (const r of rows) {
      const d = new Date(r.ts);
      const key = [
        d.getFullYear(),
        String(d.getMonth()+1).padStart(2,'0'),
        String(d.getDate()).padStart(2,'0'),
        String(d.getHours()).padStart(2,'0')
      ].join('-');
      let o = map.get(key);
      if (!o) { o = { ts: new Date(d.getFullYear(), d.getMonth(), d.getDate(), d.getHours()), t: [], h: [] }; map.set(key, o); }
      if (r.temp!==null && !Number.isNaN(r.temp)) o.t.push(r.temp);
      if (r.hum !==null && !Number.isNaN(r.hum )) o.h.push(r.hum);
    }
    const out = Array.from(map.values()).sort((a,b)=>a.ts-b.ts).map(o => ({
      ts: o.ts,
      temp: o.t.length ? o.t.reduce((a,b)=>a+b,0)/o.t.length : null,
      hum:  o.h.length ? o.h.reduce((a,b)=>a+b,0)/o.h.length : null,
    }));
    return out;
  }

  // === Naƒçten√≠ CSV ===
  let text = '';
  try {
    const resp = await fetch(CSV_URL, { cache: 'no-store' });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    text = await resp.text();
  } catch (e) {
    console.error('Nepoda≈ôilo se naƒç√≠st CSV:', e);
    alert('Nepoda≈ôilo se naƒç√≠st data (CSV). Ovƒõ≈ô, ≈æe je soubor v /docs/data/history.csv a Pages jsou zapnut√©.');
    return;
  }

  // Robustn√≠ parsing CSV
  const lines = text.replace(/\uFEFF/g,'').split(/\r?\n/).filter(l => l.trim().length > 0);
  const headerIdx = lines.findIndex(l => /^timestamp_iso,/.test(l.trim()));
  const header = (headerIdx >= 0 ? lines[headerIdx] : lines[0]).split(',');
  const idxTs = header.indexOf('timestamp_iso');
  const idxT  = header.indexOf('temp_c');
  const idxH  = header.indexOf('humidity_pct');
  const rows  = (headerIdx >= 0 ? lines.slice(headerIdx+1) : lines.slice(1));

  const raw = [];
  for (const l of rows) {
    if (/^timestamp_iso,/.test(l)) continue;
    const p = l.split(',');
    if (p.length < 3) continue;
    const ts = new Date(p[idxTs]);
    const tStr = (p[idxT] || '').replace(',', '.').trim();
    const hStr = (p[idxH] || '').replace(',', '.').trim();
    const temp = tStr === '' ? null : Number(tStr);
    const hum  = hStr === '' ? null : Number(hStr);
    if (isNaN(ts)) continue;
    if ((temp === null || isNaN(temp)) && (hum === null || isNaN(hum))) continue;
    raw.push({ ts, temp: isNaN(temp) ? null : temp, hum: isNaN(hum) ? null : hum });
  }

  // === UI prvky ===
  const showTemp = document.getElementById('showTemp');
  const showHum  = document.getElementById('showHum');
  const fromDate = document.getElementById('fromDate');
  const toDate   = document.getElementById('toDate');
  const customRange = document.getElementById('customRange');
  const applyRange  = document.getElementById('applyRange');
  const pills = document.querySelectorAll('.pill[data-range]');
  const toggleCustom = document.getElementById('toggleCustom');
  const aggSel = document.getElementById('agg');
  const smooth = document.getElementById('smooth');
  const themeBtn = document.getElementById('theme');

  const sCount = document.getElementById('s-count');
  const sT = document.getElementById('s-t');
  const sH = document.getElementById('s-h');
  const sGaps = document.getElementById('s-gaps');

  // T√©ma
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'light') document.documentElement.classList.add('light');
  themeBtn.addEventListener('click', () => {
    document.documentElement.classList.toggle('light');
    localStorage.setItem('theme', document.documentElement.classList.contains('light') ? 'light':'dark');
  });

  const ctx = document.getElementById('chart').getContext('2d');
  let chart;
  let currentPreset = 'today';
  let currentRows = []; // pro plugin s v√Ωpadky
  let gapTimes = [];

  function setActive() {
    pills.forEach(b => b.setAttribute('aria-pressed', String(b.dataset.range === currentPreset)));
  }

  function rangeFilter(arr) {
    const now = new Date();
    let from = new Date(0), to = new Date(8640000000000000);
    switch (currentPreset) {
      case 'today': {
        const d0 = new Date(now); d0.setHours(0,0,0,0);
        const d1 = new Date(now); d1.setHours(23,59,59,999);
        from=d0; to=d1; break;
      }
      case '7d':  from = new Date(now.getTime() - 7*24*3600*1000); break;
      case '30d': from = new Date(now.getTime() - 30*24*3600*1000); break;
      case 'custom':
        if (fromDate.value) from = new Date(fromDate.value + 'T00:00:00');
        if (toDate.value)   to   = new Date(toDate.value   + 'T23:59:59');
        break;
      case 'all': default: break;
    }
    return arr.filter(d => d.ts >= from && d.ts <= to).sort((a,b)=>a.ts-b.ts);
  }

  // Plugin pro svisl√© ƒç√°ry ve v√Ωpadc√≠ch
  const gapPlugin = {
    id: 'gapPlugin',
    afterDatasetsDraw(chart, args, pluginOptions) {
      const {ctx, chartArea:{top,bottom}} = chart;
      const xScale = chart.scales.x;
      ctx.save();
      ctx.setLineDash([5,5]);
      ctx.lineWidth = 1;
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--err').trim() || '#ff6b8b';
      gapTimes.forEach(ts => {
        const x = xScale.getPixelForValue(ts);
        if (x >= xScale.left && x <= xScale.right) {
          ctx.beginPath();
          ctx.moveTo(x, top);
          ctx.lineTo(x, bottom);
          ctx.stroke();
        }
      });
      ctx.restore();
    }
  };
  Chart.register(gapPlugin);

  function computeGaps(rows) {
    const diffs = [];
    for (let i=1;i<rows.length;i++) {
      const dt = rows[i].ts - rows[i-1].ts;
      if (Number.isFinite(dt)) diffs.push(dt);
    }
    const med = median(diffs); // bƒõ≈æn√Ω interval
    const threshold = Number.isFinite(med) ? med*2 : 45*60*1000; // aspo≈à 2√ó bƒõ≈æn√Ω, fallback 45 min
    const out = [];
    for (let i=1;i<rows.length;i++) {
      const dt = rows[i].ts - rows[i-1].ts;
      if (dt > threshold) out.push(rows[i].ts); // ƒç√°ra na zaƒç√°tku ‚Äûpo v√Ωpadku‚Äú
    }
    return out;
  }

  function updateStats(rows) {
    sCount.textContent = rows.length;

    const tVals = rows.map(r=>r.temp).filter(v => v!==null && !Number.isNaN(v));
    const hVals = rows.map(r=>r.hum ).filter(v => v!==null && !Number.isNaN(v));

    const tMin = tVals.length ? Math.min(...tVals) : NaN;
    const tMax = tVals.length ? Math.max(...tVals) : NaN;
    const tAvg = avg(tVals);

    const hMin = hVals.length ? Math.min(...hVals) : NaN;
    const hMax = hVals.length ? Math.max(...hVals) : NaN;
    const hAvg = avg(hVals);

    sT.textContent = `${fmt(tMin)} / ${fmt(tMax)} / ${fmt(tAvg)}`;
    sH.textContent = `${fmt(hMin)} / ${fmt(hMax)} / ${fmt(hAvg)}`;
    sGaps.textContent = gapTimes.length ? gapTimes.length : '0';
  }

  function redraw() {
    // 1) rozsah
    let rows = rangeFilter(raw);

    // 2) agregace
    if (aggSel.value === 'hour') rows = aggregateHourly(rows);

    // 3) vyhlazen√≠ (jen vizu√°ln√≠ ‚Äì MA-5)
    const labels = rows.map(r => r.ts);
    let tData = rows.map(r => r.temp);
    let hData = rows.map(r => r.hum);
    if (smooth.checked) {
      tData = movingAverage(tData, 5);
      hData = movingAverage(hData, 5);
    }

    currentRows = rows.slice();
    gapTimes = computeGaps(rows);

    // 4) limity osy teploty (dynamick√©)
    const tVals = tData.filter(v => v !== null && !Number.isNaN(v));
    const tMin = tVals.length ? Math.min(...tVals) : undefined;
    const tMax = tVals.length ? Math.max(...tVals) : undefined;
    const tRange = (tMin !== undefined && tMax !== undefined)
      ? { suggestedMin: tMin - Math.abs(tMax - tMin)*0.1,
          suggestedMax: tMax + Math.abs(tMax - tMin)*0.1 }
      : {};

    // 5) dataset(y)
    const datasets = [];
    if (showTemp.checked) datasets.push({
      label:'Teplota (¬∞C)', data:tData, yAxisID:'yTemp',
      tension: smooth.checked ? 0.35 : 0.25, spanGaps:true, pointRadius:0
    });
    if (showHum.checked)  datasets.push({
      label:'Vlhkost (%)',  data:hData, yAxisID:'yHum',
      tension: smooth.checked ? 0.35 : 0.25, spanGaps:true, pointRadius:0
    });

    // 6) graf
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets },
      options: {
        parsing: false, // u≈æ pos√≠l√°me ƒçist√° pole
        normalized: true,
        responsive:true,
        maintainAspectRatio:false,
        animation:false,
        interaction:{ mode:'index', intersect:false },
        scales:{
          x:{ type:'time', time:{ tooltipFormat:'Pp' }, ticks:{ autoSkip:true, maxRotation:0 } },
          yTemp:{ title:{ display:true, text:'¬∞C' }, grid:{ drawBorder:false }, ...tRange },
          yHum:{ position:'right', title:{ display:true, text:'%' }, grid:{ drawOnChartArea:false }, suggestedMin:0, suggestedMax:100 }
        },
        plugins:{ legend:{ position:'top' } }
      },
      plugins: ['gapPlugin']
    });

    updateStats(rows);
  }

  // Ovl√°d√°n√≠
  pills.forEach(b => {
    b.addEventListener('click', () => {
      currentPreset = b.dataset.range;
      customRange.style.display = 'none';
      setActive(); redraw();
    });
  });
  document.getElementById('toggleCustom').addEventListener('click', () => {
    customRange.style.display = (customRange.style.display === 'none' || !customRange.style.display) ? 'flex' : 'none';
  });
  applyRange.addEventListener('click', () => { currentPreset = 'custom'; setActive(); redraw(); });

  showTemp.addEventListener('change', redraw);
  showHum .addEventListener('change', redraw);
  aggSel  .addEventListener('change', redraw);
  smooth  .addEventListener('change', redraw);

  // Ulo≈æen√≠ grafu
  document.getElementById('dlPng').addEventListener('click', () => {
    const a = document.createElement('a');
    a.href = chart.toBase64Image();
    a.download = `meteo_${new Date().toISOString().slice(0,19)}.png`;
    a.click();
  });

  // Start
  setActive();
  redraw();
})();
</script>
</body>
</html>
