<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Meteo archiv</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js"></script>
  <style>
    :root {
      --bg: #0f1115;
      --card: #171a21;
      --muted: #9aa4b2;
      --text: #e7edf4;
      --accent: #2dd4bf;
      --danger: #f43f5e;
      --info: #60a5fa;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;}
    header{display:flex;align-items:center;gap:.6rem;padding:14px 18px;border-bottom:1px solid #222;}
    header .logo{width:22px;height:22px;background:radial-gradient(circle at 30% 30%,#ffd166,#ff9900);border-radius:50%;}
    header h1{font-size:1.05rem;margin:0;font-weight:700}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    .controls{display:flex;flex-wrap:wrap;gap:.6rem;align-items:center;margin-bottom:.8rem}
    .controls .group{display:flex;gap:.6rem;align-items:center;background:var(--card);padding:8px 10px;border-radius:10px}
    label{display:inline-flex;gap:.35rem;align-items:center;cursor:pointer;font-size:.95rem}
    input[type="checkbox"]{width:18px;height:18px;accent-color:var(--accent)}
    /* UPRAVENO: P≈ôid√°n input[type="datetime-local"] pro stylov√°n√≠ pol√≠ pro vlastn√≠ rozsah */
    select,button,input[type="datetime-local"]{background:#111722;color:var(--text);border:1px solid #223047;border-radius:10px;padding:8px 10px;font-size:.95rem}
    button.icon{display:inline-flex;gap:.4rem;align-items:center}
    button#btnCsv{background:#0b3b73;border-color:#0b3b73}
    button#btnPng{background:#0b5d48;border-color:#0b5d48}
    button#btnReset{background:#5a3b09;border-color:#5a3b09}
    .stats{display:flex;gap:.8rem;flex-wrap:wrap;margin:.6rem 0}
    .stat{flex:1 1 280px;background:var(--card);border-radius:12px;padding:12px 14px}
    .stat .ttl{font-size:.9rem;color:var(--muted);margin-bottom:.25rem}
    .stat .val{font-size:1.6rem;font-weight:800}
    .stat .sub{margin-top:.15rem;color:var(--muted);font-size:.88rem}
    .chart-card{background:#fff;border-radius:12px;padding:10px}
    canvas{display:block;width:100%;height:420px;max-height:70vh}
    .bad{color:#ff8484}
    #rangeBadge{font-size:.85rem;color:var(--muted)}
    .sensorPills{display:flex;flex-wrap:wrap;gap:.5rem}
    .pill{background:#0d1320;border:1px solid #263246;color:#cfe7ff;padding:4px 10px;border-radius:999px;font-size:.85rem}
    @media (max-width:700px){
      .controls .group{width:100%;justify-content:space-between}
      /* √öPRAVA: Aby se ovl√°d√°n√≠ vlastn√≠ho rozsahu zalamovalo na men≈°√≠ch obrazovk√°ch */
      #customRangeGroup{flex-wrap:wrap}
      #customRangeGroup input{flex:1 1 45%;min-width:140px} 
      canvas{height:360px}
    }
  </style>
</head>
<body>
  <header>
    <div class="logo"></div>
    <h1>Meteo archiv</h1>
  </header>

  <div class="wrap">
    <div class="controls">
      <div class="group">
        <label><input id="chkTemp" type="checkbox" checked> Teplota (¬∞C)</label>
        <label><input id="chkHum" type="checkbox" checked> Vlhkost (%)</label>
      </div>

      <div class="group">
        <select id="selRange">
          <option value="today" selected>Dne≈°ek</option>
          <option value="week">T√Ωden</option>
          <option value="month">Mƒõs√≠c</option>
          <option value="all">V≈°e</option>
          <option value="custom">Vlastn√≠</option>
        </select>

        <div id="customRangeGroup" style="display:none; gap:.6rem;">
          <input type="datetime-local" id="dateFrom" title="Datum a ƒças Od">
          <input type="datetime-local" id="dateTo" title="Datum a ƒças Do">
        </div>

        <select id="selFile"></select>

        <button id="btnReset" class="icon" title="Reset zoom"><span>‚Ü∫</span> Reset</button>
        <button id="btnCsv" class="icon" title="St√°hnout CSV">üìÑ CSV</button>
        <button id="btnPng" class="icon" title="St√°hnout PNG graf">üñº PNG</button>
      </div>
    </div>

    <div class="controls">
      <div id="sensorBox" class="sensorPills"></div>
      <span id="rangeBadge"></span>
    </div>

    <div class="stats">
      <div class="stat">
        <div class="ttl">Min. teplota</div>
        <div class="val" id="minVal">‚Äì</div>
        <div class="sub" id="minInfo">‚Äì</div>
      </div>
      <div class="stat">
        <div class="ttl">Max. teplota</div>
        <div class="val" id="maxVal">‚Äì</div>
        <div class="sub" id="maxInfo">‚Äì</div>
      </div>
    </div>

    <div class="chart-card"><canvas id="chart"></canvas></div>
  </div>

  <script>
    // --- Pomocn√© ---
    const SENSOR_LABEL = { "4065": "UNI", "2764": "Venek" };

    const $ = sel => document.querySelector(sel);
    const fmt = d => new Date(d).toLocaleString();

    // NOV√â: Konstanty pro vlastn√≠ rozsah
    const $selRange = $("#selRange");
    const $customGroup = $("#customRangeGroup");
    const $dateFrom = $("#dateFrom");
    const $dateTo = $("#dateTo");

    async function fetchJSON(paths) {
      for (const p of paths) {
        try {
          const r = await fetch(p, { cache: "no-store" });
          if (r.ok) return await r.json();
        } catch {}
      }
      throw new Error("index.json nenalezen (zkou≈°eno: " + paths.join(", ") + ")");
    }
    async function fetchText(paths) {
      for (const p of paths) {
        try {
          const r = await fetch(p, { cache: "no-store" });
          if (r.ok) return await r.text();
        } catch {}
      }
      throw new Error("CSV nenalezeno (zkou≈°eno: " + paths.join(", ") + ")");
    }

    // --- Stav ---
    let allRows = [];      // p≈Øvodn√≠ data (v≈°e)
    let visibleSensors = new Set(); // viditeln√© senzory
    let chart;

    // --- Naƒçten√≠ seznamu soubor≈Ø ---
    async function loadIndex() {
      const files = await fetchJSON(["data/index.json","docs/data/index.json"]);
      const sel = $("#selFile");
      sel.innerHTML = "";
      files.forEach(f => {
        const o = document.createElement("option");
        o.value = f; o.textContent = f;
        sel.appendChild(o);
      });
      // preferuj history.csv, kdy≈æ existuje
      if (files.includes("history.csv")) sel.value = "history.csv";
      await loadCSV();
    }

    // --- Naƒçten√≠ CSV ---
    async function loadCSV() {
      const f = $("#selFile").value;
      const text = await fetchText([`data/${f}`,`docs/data/${f}`]);

      const lines = text.trim().split(/\r?\n/);
      // Podpora s/bez hlaviƒçky
      let start = 0;
      if (lines[0].toLowerCase().includes("timestamp")) start = 1;

      allRows = [];
      for (let i = start; i < lines.length; i++) {
        const [ts, id, t, h] = lines[i].split(",");
        if (!ts || !id) continue;
        const time = new Date(ts);
        const temp = parseFloat(t);
        const hum  = parseFloat(h);
        if (Number.isNaN(time.getTime())) continue;
        allRows.push({ time, id, temp, hum });
      }

      // Inicializuj viditeln√© senzory
      const ids = [...new Set(allRows.map(r => r.id))].sort();
      visibleSensors = new Set(ids);
      renderSensorToggles(ids);

      // NOV√â: Zajist√≠me spr√°vn√© zobrazen√≠/skryt√≠ pol√≠ pro vlastn√≠ rozsah
      toggleCustomRangeInputs();
      update();
    }

    // --- P≈ôep√≠naƒçe senzor≈Ø (pills) ---
    function renderSensorToggles(ids){
      const box = $("#sensorBox");
      box.innerHTML = "";
      ids.forEach(id => {
        const pill = document.createElement("label");
        pill.className = "pill";
        pill.innerHTML = `<input type="checkbox" data-id="${id}" checked style="accent-color:#2dd4bf;margin-right:6px"> ${SENSOR_LABEL[id] ?? id}`;
        pill.querySelector("input").addEventListener("change", (e)=>{
          if (e.target.checked) visibleSensors.add(id);
          else visibleSensors.delete(id);
          update();
        });
        box.appendChild(pill);
      });
    }
    
    // NOV√â: Zobrazen√≠/skryt√≠ pol√≠ pro vlastn√≠ rozsah a nastaven√≠ v√Ωchoz√≠ch hodnot
    function toggleCustomRangeInputs(){
      if ($selRange.value === "custom") {
        $customGroup.style.display = "flex"; // Zobrazit
        // Nastav√≠me v√Ωchoz√≠ hodnoty (dne≈°ek) pokud nejsou nastaven√©
        if (!$dateFrom.value || !$dateTo.value) {
            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            // Form√°t pro input[type="datetime-local"] je YYYY-MM-DDTHH:mm
            // Pou≈æijeme zjednodu≈°en√Ω UTC form√°t a p≈ôevedeme na lok√°ln√≠ ƒças pro input
            const toStr = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            const fromStr = new Date(startOfDay.getTime() - (startOfDay.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            $dateFrom.value = fromStr;
            $dateTo.value = toStr;
        }
      } else {
        $customGroup.style.display = "none"; // Skr√Ωt
      }
    }


    // --- Filtrov√°n√≠ dle rozsahu (UPRAVENO pro vlastn√≠ rozsah) ---
    function filterByRange(rows){
      const range = $selRange.value;
      const badge = $("#rangeBadge");
      
      let from = null;
      let to = new Date(); 

      // 1. Logika pro rychl√© volby
      if (range !== "custom" && range !== "all") {
        const now = new Date();
        if (range === "today") from = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        else if (range === "week") from = new Date(now.getTime() - 7*24*3600*1000);
        else if (range === "month") from = new Date(now.getTime() - 31*24*3600*1000);
        
      } 
      // 2. Logika pro vlastn√≠ rozsah ("custom")
      else if (range === "custom") {
        from = $dateFrom.value ? new Date($dateFrom.value) : null;
        to = $dateTo.value ? new Date($dateTo.value) : new Date();
        
        // Kontrola platnosti dat pro custom rozsah
        if (!from || Number.isNaN(from.getTime()) || Number.isNaN(to.getTime())) {
          badge.textContent = "Zobrazeno: Neplatn√Ω vlastn√≠ rozsah";
          return [];
        }
      }
      // 3. Logika pro "V≈°e" ("all") - from je null, to je teƒè

      // Filtr
      const filteredRows = rows.filter(r => {
        // Z√°znam mus√≠ b√Ωt >= "Od" (pokud je definov√°no)
        const afterFrom = from ? r.time.getTime() >= from.getTime() : true;
        // Z√°znam mus√≠ b√Ωt <= "Do"
        const beforeTo = r.time.getTime() <= to.getTime();
        return afterFrom && beforeTo;
      });
      
      // Aktualizace badge
      const toStr = to.toLocaleString();
      const fromStr = from ? from.toLocaleString() : "‚Äî";
      badge.textContent = `Zobrazeno: ${fromStr} ‚Äî ${toStr}`;
      
      return filteredRows;
    }

    // --- P≈ôepoƒçet statistik + render grafu ---
    function update(){
      const showTemp = $("#chkTemp").checked;
      const showHum  = $("#chkHum").checked;

      // filtrace
      const rows = filterByRange(allRows).filter(r => visibleSensors.has(r.id));

      // Statistika jen z teploty a z viditeln√Ωch senzor≈Ø
      const tRows = rows.filter(r => Number.isFinite(r.temp));
      if (tRows.length) {
        const min = tRows.reduce((a,b)=> b.temp < a.temp ? b : a);
        const max = tRows.reduce((a,b)=> b.temp > a.temp ? b : a);
        $("#minVal").textContent = `${min.temp.toFixed(2)} ¬∞C`;
        $("#maxVal").textContent = `${max.temp.toFixed(2)} ¬∞C`;
        $("#minInfo").textContent = `${SENSOR_LABEL[min.id] ?? min.id}, ${fmt(min.time)}`;
        $("#maxInfo").textContent = `${SENSOR_LABEL[max.id] ?? max.id}, ${fmt(max.time)}`;
      } else {
        $("#minVal").textContent = "‚Äì"; $("#maxVal").textContent = "‚Äì";
        $("#minInfo").textContent = "‚Äì"; $("#maxInfo").textContent = "‚Äì";
      }

      // dataset
      const ids = [...new Set(rows.map(r=>r.id))].sort();
      const datasets = [];
      const colorFor = id => id === "4065" ? "#ef4444" : "#3b82f6"; // UNI=ƒçerven√°, Venek=modr√°

      ids.forEach(id=>{
        const srows = rows.filter(r=>r.id===id);
        if (showTemp) {
          datasets.push({
            label: `${SENSOR_LABEL[id] ?? id} (¬∞C)`,
            data: srows.map(r=>({x:r.time,y:r.temp})),
            borderColor: colorFor(id),
            backgroundColor: "transparent",
            yAxisID: "yT",
            tension: .2,
            pointRadius: 0,
            borderWidth: 2
          });
        }
        if (showHum) {
          datasets.push({
            label: `${SENSOR_LABEL[id] ?? id} (%)`,
            data: srows.map(r=>({x:r.time,y:r.hum})),
            borderColor: id === "4065" ? "#f97316" : "#22d3ee",
            backgroundColor: "transparent",
            yAxisID: "yH",
            tension: .2,
            pointRadius: 0,
            borderDash: [6,4],
            borderWidth: 2
          });
        }
      });

      drawChart(datasets);
    }

    function drawChart(datasets){
      const ctx = $("#chart").getContext("2d");
      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "line",
        data: { datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          interaction: { mode: "nearest", axis: "x", intersect: false },
          scales: {
            x: {
              type: "time",
              time: { tooltipFormat: "dd.MM.yyyy HH:mm", displayFormats: { hour: "HH:mm", day: "d.M." } },
              ticks: { autoSkip: true, maxTicksLimit: 7 },
              grid: { color: "#eee2", drawBorder:false }
            },
            yT: { position: "left", title:{display:true,text:"¬∞C"}, grid:{color:"#eee2"}, suggestedMin: null, suggestedMax: null },
            yH: { position: "right", title:{display:true,text:"%"}, grid:{drawOnChartArea:false}, suggestedMin: 0, suggestedMax: 100 }
          },
          plugins: {
            legend: { labels: { color: "#111", font:{weight:"600"} } },
            zoom: {
              zoom: { wheel:{enabled:true}, pinch:{enabled:true}, mode:"x" },
              pan:  { enabled:true, mode:"x" }
            }
          }
        }
      });
    }

    // --- Akce (UPRAVENO pro vlastn√≠ rozsah) ---
    $("#selFile").addEventListener("change", loadCSV);
    
    // Slouƒç√≠me akce pro selRange
    $selRange.addEventListener("change", ()=>{
        toggleCustomRangeInputs(); // P≈ôepne zobrazen√≠ pol√≠
        update(); // Aktualizuje graf
    });

    $("#chkTemp").addEventListener("change", update);
    $("#chkHum").addEventListener("change", update);

    // NOV√ç POSLUCHAƒåI pro pole vlastn√≠ho rozsahu
    $dateFrom.addEventListener("change", update);
    $dateTo.addEventListener("change", update);

    $("#btnReset").addEventListener("click", ()=> chart && chart.resetZoom());
    $("#btnCsv").addEventListener("click", ()=> {
      const f = $("#selFile").value;
      // preferuj /data - kdy≈æ neexistuje, vezmi /docs/data
      fetch(`data/${f}`,{method:"HEAD"}).then(r=>{
        location.href = r.ok ? `data/${f}` : `docs/data/${f}`;
      }).catch(()=> location.href = `data/${f}`);
    });
    $("#btnPng").addEventListener("click", ()=>{
      const a = document.createElement("a");
      a.href = chart.toBase64Image(); a.download = "graf.png"; a.click();
    });

    // start
    loadIndex().catch(err=>{
      console.error(err);
      alert("Nepoda≈ôilo se naƒç√≠st data (index.json). Zkontroluj, ≈æe existuje v `docs/data/`.");
    });
  </script>
</body>
</html>
